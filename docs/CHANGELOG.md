# 更新紀錄

## 2025-12-XX（階段版本 v1.6）

### 玩法擴充：新增技能與特效系統
- **法師新增技能**：
  - **降速光環**：光圈內的敵人速度減少 12%/級（最大Lv5，最高減速 60%）。
  - **光環縮放系統**：光環範圍會隨時間呼吸式縮放，傷害判定範圍與視覺範圍完全同步。
- **弓箭手新增技能**：
  - **致命一擊 (Critical)**：5%/級機率造成 2 倍傷害（最大Lv10）。觸發時顯示大型金色傷害數字與閃光特效。
  - **爆炸箭矢增強**：被箭矢直接命中的敵人現在會同時受到「箭矢傷害」與「爆炸傷害」（雙重傷害）。
  - **爆炸範圍提升**：爆炸範圍增量加倍（每級 +20px）。
- **騎士新增技能**：
  - **無敵 (Invincibility)**：死亡後觸發全隊無敵（1秒/級，最大Lv5）。
  - **無敵視覺優化**：全隊勇者同步閃爍淺黃色（使用 `lighter` 混合模式），隊長頭頂顯示倒數計時，移除全屏黃色濾鏡以保護眼睛。

### 遊戲平衡與 GM 工具
- **GM 測試工具增強**：
  - 修改能力等級時，玩家等級會自動同步更新（Player Level = Total Upgrade Level）。
  - 怪物強度會根據新的玩家等級自動調整。
  - 支援動態增減能力，並自動處理能力類型解鎖/上鎖邏輯。
- **平衡調整**：
  - **弓箭手爆炸範圍**：每級增加範圍從 +20px 提升至 +30px。
  - **騎士死亡爆炸範圍**：每級增加範圍從 +30px 提升至 +40px。
  - **騎士可承受攻擊次數**：等級上限從 10 下修為 5。

### 技術優化
- **渲染效能**：
  - 法師光環繪製優化：不再將光環推入 `effects` 陣列，改為直接在 `draw` 循環中繪製。
  - 無敵閃爍優化：閃爍計算移至循環外，降低頻率（2Hz），僅在亮度足夠時執行繪製操作。
  - 圖片預解碼：使用 `Image.decode()` 或離屏 Canvas 預先解碼圖片，防止首次繪製卡頓。

## 2025-12-XX（階段版本 v1.5）

### 玩法擴充：新增升級選項與能力類型系統
- **能力類型限制系統**：
  - 每輪遊戲最多可解鎖 10 種不同的能力類型
  - 鼓勵玩家專精特定能力，增加策略性
  - 能力類型計數器顯示在遊戲界面（「能力類型: X/10」）
  - 滿級選擇（隊長最大血量+1）不計入能力類型限制
  - 達到上限後，未解鎖的選項會變半透明且無法選擇

- **騎士新增升級選項**：
  - **死亡爆炸範圍**：騎士死亡時爆炸範圍 +30px/級，起始 0，最大 Lv8
  - **死亡爆炸傷害**：騎士死亡時爆炸傷害 +10/級，起始 0，最大 Lv8
  - 騎士死亡時對範圍內所有敵人造成傷害，並顯示金色爆炸特效

- **弓箭手升級調整與新增**：
  - **弓箭數量**：等級上限從 3 上修為 5
  - **射擊速度**：等級上限從 10 下修為 8
  - **箭矢爆炸範圍**：命中怪物後爆炸範圍 +10px/級，起始 0，最大 Lv5
  - **箭矢爆炸傷害**：命中怪物後爆炸傷害 +5/級，起始 0，最大 Lv5
  - 箭矢擊中敵人時對範圍內其他敵人造成額外傷害，並顯示綠色爆炸特效

- **法師新增升級選項**：
  - **縮放效果**：縮放百分比 +10%/級，起始 0，最大 Lv5
  - 每兩秒一個完整的縮放循環（1.0 → 1+bonus → 1.0）
  - 使用 sin 函數創建平滑的呼吸式縮放動畫
  - 光環視覺大小也跟隨縮放（實際傷害範圍不變）

### 測試功能
- **測試修改按鈕**：
  - 位置：遊戲界面能力類型文字最右邊
  - 圖標：🔧（紅色背景，與其他按鈕區分）
  - 功能：點擊後遊戲暫停，彈出密碼輸入框

- **密碼保護**：
  - 密碼：`690630`
  - 支持 Enter 鍵快速確認
  - 密碼錯誤時顯示錯誤提示
  - 右上角 X 按鈕可關閉並恢復遊戲

- **修改視窗**：
  - 列出所有能力選項（按職業分類：隊長、弓箭手、法師、騎士）
  - 顯示職業名稱、能力名稱、描述、當前等級、最大等級
  - 加減按鈕可調整等級（+ / -）
  - 能力類型達上限時，未解鎖選項變半透明且無法點擊
  - 實時更新能力類型計數器
  - 右上角 X 按鈕可關閉並恢復遊戲

### 技術實現
- **爆炸效果系統**：
  - 騎士死亡爆炸：金色特效（`#f59e0b`），從中心向外擴散
  - 弓箭爆炸：綠色特效（`#22c55e`），環狀擴散
  - 爆炸特效使用 `effects` 陣列管理，逐漸淡出

- **法師縮放系統**：
  - 使用 `performance.now()` 追蹤時間
  - 每 2000ms 一個完整循環
  - 使用 `Math.sin()` 創建平滑縮放曲線
  - 應用 `ctx.translate()` 和 `ctx.scale()` 實現從中心點縮放

- **能力類型追蹤**：
  - 使用 `Set` 數據結構追蹤已解鎖的能力類型（格式：`role.key`）
  - 升級時自動加入/移除追蹤
  - 實時更新 UI 顯示

## 2025-12-XX（階段版本 v1.4）

### UI/UX 優化與修復
- **遊戲說明 UI 調整**：
  - 移除「快速指引」標題（設為空字串）
  - 將「操作方式」移到最前面（從 `tip` 移到 `intro`）
  - 更新操作方式文字：包含滑鼠/手指拖曳描述
  - 將「招募道具」改名為「招募勇者」
  - 修改 `renderGuidePanel()` 函數，不顯示空的標題，不顯示 `tip`（已移到 `intro`）

- **排行榜 UI 重大改進**：
  - 標題「排行榜」置中並美化：字體大小 1.5rem、字體粗細 700、字間距 2px、添加發光效果
  - 添加 X 按鈕在右上角（與遊戲說明一致）
  - 按鈕顯示邏輯優化：
    - 從主選單打開：隱藏「重新開始」和「回主選單」按鈕（使用 X 關閉）
    - 從遊戲中打開：隱藏「重新開始」和「回主選單」按鈕（使用 X 關閉，恢復遊戲）
    - 從死亡時打開：顯示「重新開始」按鈕，隱藏「回主選單」按鈕（使用 X 關閉）
  - 按鈕置中：改為垂直排列（`flex-direction: column`），按鈕置中（`align-items: center`），最大寬度 300px
  - X 按鈕功能：關閉排行榜，如果遊戲還在進行中會恢復遊戲並開始倒數

- **遊戲說明 X 按鈕修復**：
  - 修復從遊戲中打開遊戲說明，按 X 關閉後沒有倒數的問題
  - 添加邏輯：如果遊戲還在進行中（非遊戲結束狀態），關閉後會調用 `startCountdown()` 開始倒數三秒

### 配置文件更新
- **`guide-config.js`**：
  - 移除 `title`（設為空字串）
  - 移除 `intro`（原開場說明）
  - 將 `tip` 內容移到 `intro` 位置（操作方式移到最前面）
  - 更新操作方式文字：`"操作方式：WASD / 方向鍵控制，或使用滑鼠/手指拖曳移動；保持隊伍迴旋可避開敵人。"`
  - 將「招募道具」改名為「招募勇者」

## 2025-11-22（階段版本 v1.3）

### ⚠️ 重要技術經驗：移動流暢度優化

**問題**：實作碰撞效果後，玩家移動出現明顯卡頓，有「一格一格跳動」的感覺，但怪物移動卻很平滑。

**根本原因**：
1. **指數插值 vs 線性插值**：
   - 之前使用指數插值（`renderX += dx * lerpSpeed`）
   - 這會導致前幾幀快速移動，後面幾乎不動
   - 可能在 40-60ms 就完成 95%，剩下 60-80ms 幾乎靜止
   - 造成「快速移動 → 停頓 → 快速移動」的循環

2. **怪物為何平滑**：
   - 怪物每幀都移動小距離（`e.x += Math.cos(angle) * ENEMY_SPEED`）
   - 純連續移動，沒有網格跳躍
   - 不使用插值，所以沒有插值問題

**解決方案**：
- **改用線性插值**：根據時間進度（`moveProgress = timeSinceMove / moveSpeed`）直接計算位置
- **公式**：`renderX = startX + (targetX - startX) * moveProgress`
- **效果**：在整個移動間隔（120ms）內均勻移動，0ms 在起點，120ms 正好到達終點
- **記錄起始位置**：每次 `moveSnake` 時記錄 `startRenderX/Y`，作為插值起點

**關鍵程式碼**：
```javascript
// 在 moveSnake 中記錄起始位置
s.startRenderX = s.renderX;  // 記錄插值起點
s.startRenderY = s.renderY;
s.targetRenderX = s.x;       // 設置目標位置
s.targetRenderY = s.y;

// 在 gameLoop 中使用線性插值
const moveProgress = Math.min(timeSinceMove / currentMoveSpeed, 1);
s.renderX = s.startRenderX + (s.targetRenderX - s.startRenderX) * moveProgress;
s.renderY = s.startRenderY + (s.targetRenderY - s.startRenderY) * moveProgress;
```

**經驗教訓**：
- ❌ 不要在 `moveSnake` 中重置 `renderX/Y` 為當前邏輯位置
- ❌ 不要使用指數插值（會有不均勻的速度）
- ✅ 使用線性插值，根據時間進度計算位置
- ✅ 記錄插值起點（`startRenderX/Y`），不要依賴累積式更新
- ✅ 確保插值在移動間隔結束時正好完成

### UI/UX 重大優化
- **載入畫面改進**：
  - 100% 載入完成後不再消失，改為顯示「勇者今日名言」
  - 隨機顯示勇者幹話（12 條），分為生存、貪婪、團隊、戰鬥四大類
  - 建立 `hero-quotes-config.js` 獨立配置文件，方便新增/修改名言
  - 名言文字左對齊顯示，更易閱讀

- **HUD 布局優化**：
  - 建立獨立的頂部 HUD 區域（136px 高），不遮擋遊戲區域
  - 小地圖縮小：150px → 120px
  - 按鈕位置調整：從右上角移到經驗值下方，更符合人體工學
  - 按鈕尺寸調整：44px → 36px，減少遮擋
  - 遊戲 Canvas 從 HUD 下方開始（`margin-top: 136px`），視覺更清晰
  - 使用半透明背景和模糊效果（`backdrop-filter`）

- **滑鼠滑動控制**：
  - 新增滑鼠拖曳滑動功能，與觸控手勢相同體驗
  - 顯示滑動軌跡線與方向箭頭
  - 修正座標偏移問題（使用 `getBoundingClientRect` 轉換 Canvas 相對座標）
  - 箭頭視覺增強：大小增加（28px x 12px），添加綠色邊框，不透明度提高到 0.9
  - 滑鼠和觸控共用相同的控制邏輯（`handleSwipeControl`）
  - 新增座標轉換函數（`getCanvasCoordinates` 和 `getCanvasCoordinatesFromTouch`）

### 遊戲平衡調整
- **基礎速度調整**：
  - 勇者移動速度：150ms → 200ms → 120ms（經過多次調整找到最佳值）
  - 敵人移動速度：1.5 → 1.2（降低追擊壓力）
  
- **隊長升級系統擴充**：
  - 新增「移動速度」升級選項（最大 Lv5）
  - 每次升級減少 15ms 移動間隔，最快可達 45ms（超快速）
  - 調整「傷害」升級：最大等級保持 5，每次增量從 +1 改為 +5
  - 在 `upgradeLevels` 中添加 `moveSpeed` 屬性
  - 新增 `getCurrentMoveSpeed()` 函數應用升級效果
  - 修正升級描述顯示：對於負數 increment 顯示絕對值

### 碰撞效果優化
- **怪物碰撞回彈**：
  - 增加推開距離：30px → 50px
  - 添加緩停效果：碰撞後停止移動 12 幀（約 200ms @ 60fps）
  - 緩停期間不追擊玩家，給予反應時間
  - 使用 `stunTimer` 屬性控制緩停狀態

- **我方單位受傷視覺**：
  - 碰撞時顯示深紅色閃爍效果（`#8b0000`，半透明覆蓋 60%）
  - 持續 10 幀，清楚標示受傷狀態
  - 領隊和其他隊員都有受傷反饋
  - 使用 `hitTimer` 屬性控制閃爍狀態
  - 將 `hitTimer` 更新從繪製階段移到邏輯更新階段，提升性能

- **回彈效果調整**：
  - 玩家回彈力度：從 0.5 降低到 0.3（減少對移動的干擾）
  - 回彈衰減係數：從 0.85 → 0.9 → 0.92 → 0.95（更快消失）
  - 確保回彈不影響正常移動流暢度

### 移動系統重構（重要技術改進）
- **從指數插值改為線性插值**：
  - **問題**：指數插值（`renderX += dx * lerpSpeed`）會在前幾幀快速移動，後面緩慢接近目標，造成「移動 → 停頓」的感覺
  - **解決**：線性插值（`renderX = startX + (targetX - startX) * moveProgress`）確保在整個移動間隔內均勻移動
  - **效果**：移動速度恆定，沒有停頓感，與怪物移動一樣平滑

- **插值起點記錄**：
  - 在 `moveSnake` 中記錄插值起點（`startRenderX/Y = renderX/Y`）
  - 避免依賴累積式更新，確保插值計算正確

- **時間基準插值**：
  - 使用 `moveProgress = timeSinceMove / currentMoveSpeed` 計算時間進度（0.0 到 1.0）
  - 根據時間進度直接計算位置，確保在移動間隔結束時正好到達目標

- **移除不必要的重置邏輯**：
  - 移除在 `moveSnake` 中檢查和重置 `renderX/Y` 的邏輯
  - 避免頻繁重置造成視覺跳躍

### 配置文件新增
- **`hero-quotes-config.js`**：
  - 包含所有勇者幹話的陣列（`window.HERO_QUOTES`）
  - 可直接編輯此文件來新增、修改或刪除名言
  - 分為四大類：生存、貪婪、團隊、戰鬥
  - 計時器更新移到邏輯階段，避免在繪製時更新狀態

### 移動系統重大修復（⭐ 關鍵經驗）
- **問題診斷過程**：
  - 初期症狀：移動有停頓感，像是"一格一格跳動"
  - 嘗試過的方案：提高 Lerp 速度、降低移動間隔、優化回彈效果等（都無效）
  - 關鍵發現：**怪物移動很平滑，玩家卻卡頓** → 兩者的移動方式不同
  
- **根本原因**：
  - **指數插值的問題**：使用 `renderX += (targetX - renderX) * lerpSpeed` 的指數衰減插值
    - 前幾幀移動很快（完成 60-90% 距離）
    - 後幾幀越來越慢（完成剩餘 10-40%）
    - 導致"快速移動 → 停頓等待 → 快速移動"的節奏感
    - 視覺上感覺像是"一格一格跳動"
  - **怪物為何平滑**：怪物每幀都移動小距離（`ENEMY_SPEED = 1.2px`），純連續移動，沒有離散的網格跳躍
  
- **正確解決方案：線性插值**：
  - 改用 `renderX = startX + (targetX - startX) * moveProgress`
  - `moveProgress` 根據時間計算：`(timestamp - lastMoveTime) / currentMoveSpeed`（0.0 到 1.0）
  - 移動速度恆定，在整個移動間隔內均勻移動
  - 0ms 時在起點，120ms 時正好到達終點
  - **完全消除停頓感**
  
- **實作細節**：
  - 在 `moveSnake` 中記錄 `startRenderX/Y`（插值起始位置）
  - 在 `gameLoop` 中每幀根據時間進度計算當前位置
  - 回彈效果疊加在插值之上，不干擾正常移動
  
- **重要教訓**：
  - **指數插值適合快速到達目標並停止的場景**（如：UI 動畫、相機跟隨）
  - **線性插值適合恆定速度移動的場景**（如：角色移動、物體運動）
  - 診斷移動問題時，應對比"流暢的參考物"（如怪物移動），找出差異
  - 移動卡頓問題往往不是速度太慢，而是**速度不均勻**

## 2025-11-22（階段版本 v1.2）
  
- **根本原因**：
  - **指數插值的問題**：使用 `renderX += (targetX - renderX) * lerpSpeed` 的指數衰減插值
    - 前幾幀移動很快（完成 60-90% 距離）
    - 後幾幀越來越慢（完成剩餘 10-40%）
    - 導致"快速移動 → 停頓等待 → 快速移動"的節奏感
    - 視覺上感覺像是"一格一格跳動"
  - **怪物為何平滑**：怪物每幀都移動小距離（`ENEMY_SPEED = 1.2px`），純連續移動，沒有離散的網格跳躍
  
- **解決方案**：
  - **改用線性插值**：`renderX = startX + (targetX - startX) * moveProgress`
    - `moveProgress` 根據時間計算：`timeSinceMove / currentMoveSpeed`（0.0 到 1.0）
    - 移動速度恆定，在整個移動間隔內均勻移動
    - 0ms 時在起點，120ms 時正好到達終點
    - **完全消除停頓感**
  - 在 `moveSnake` 中記錄 `startRenderX/Y`（插值起始位置）
  - 在 `gameLoop` 中每幀根據時間進度計算當前位置
  
- **重要教訓**：
  - **指數插值適合快速到達目標並停止的場景**（如：UI 動畫、相機跟隨）
  - **線性插值適合恆定速度移動的場景**（如：角色移動、物體運動）
  - 診斷移動問題時，應對比"流暢的參考物"（如怪物移動），找出差異
  - 移動卡頓問題往往不是速度太慢，而是**速度不均勻**
  
- **技術細節**：
  - 移動邏輯（`moveSnake`）每 120ms 執行一次，更新邏輯位置（`x, y`）
  - 插值邏輯（`gameLoop` 中的 Lerp）每幀執行（約 16ms @ 60fps），更新視覺位置（`renderX/Y`）
  - 線性插值確保視覺位置在 120ms 內勻速從起點移動到終點
  - 回彈效果疊加在插值之上，不干擾正常移動
  
- **根本原因**：
  - **指數插值（Exponential Lerp）的陷阱**：
    ```javascript
    // 錯誤做法：指數插值
    s.renderX += (targetX - s.renderX) * 0.6;
    ```
    - 前 40-60ms 快速移動（完成 95%）
    - 後 60-80ms 幾乎不動（剩下 5%）
    - 造成"快 → 停頓"的視覺效果
  
  - **怪物為何平滑**：
    - 怪物每幀移動固定距離（`ENEMY_SPEED = 1.2px`）
    - 純連續移動，沒有離散跳躍
    - 不使用網格系統

- **正確解決方案**：
  - 使用**線性插值（Linear Lerp）**：
    ```javascript
    // 正確做法：線性插值
    const moveProgress = timeSinceMove / moveInterval;  // 0.0 到 1.0
    s.renderX = startX + (targetX - startX) * moveProgress;
    ```
  - 確保移動速度恆定，沒有快慢變化
  - 在整個移動間隔（120ms）內均勻移動
  - 0ms 時在起點，120ms 時正好到達終點

- **實作細節**：
  - 記錄插值起始位置（`startRenderX/Y`）
  - 根據時間進度計算當前位置
  - 回彈效果獨立疊加，不影響主要移動

- **關鍵經驗**：
  - ⚠️ **指數插值不適合固定間隔的網格移動**（會造成停頓感）
  - ✅ **線性插值適合固定間隔的網格移動**（移動均勻流暢）
  - 💡 **對比參照物很重要**：怪物移動平滑 → 說明問題在玩家移動邏輯，不是性能問題

## 2025-12-XX（階段版本 v1.1）

### 遊戲系統修復與優化
- **重大修復**：修復多個遊戲核心系統問題，提升遊戲體驗
- **實作細節**：
  - **移動系統修復**：
    - 修復遊戲開始後不會移動的問題（初始化時間戳記）
    - 修復小地圖沒有內容的問題（添加 null 檢查，修正道具和敵人繪製邏輯）
  - **法師光環系統完善**：
    - 實作完整的法師光環傷害系統（`handleMageAura()`）
    - 修復法師光環視覺特效（移除內圈光暈，恢復敵人被傷害時的發光效果）
    - 修復光環傷害範圍與視覺範圍不一致的問題（考慮線條寬度和怪物大小）
    - 添加傷害間隔機制（`AURA_HIT_INTERVAL = 200ms`），降低傷害頻率
    - 調整法師光環傷害：初始值從 5 改為 3，升級增量從 0.5 改為 3
  - **弓箭手系統優化**：
    - 修復弓箭穿透問題（一支箭只能擊中一個敵人）
    - 調整攻擊範圍：從 150 像素（約 3.75 格）改為 280 像素（約 7 格）
    - 添加攻擊範圍檢查，只攻擊範圍內的敵人
  - **領隊傷害系統**：
    - 修復領隊碰到怪物時對怪物造成傷害的邏輯
    - 使用升級後的領隊傷害值對敵人造成傷害
  - **騎士守護系統完善**：
    - 實作完整的騎士 hitPoints 系統（不再直接移除騎士）
    - 修復一次死兩隻騎士的問題（添加碰撞冷卻時間和單次處理機制）
    - 添加碰撞冷卻時間（`COLLISION_COOLDOWN = 300ms`）
    - 騎士死亡獎勵改為隨機職業（不只是騎士）
  - **升級系統優化**：
    - 修復升級選項隨機性問題（確保所有職業選項都有公平出現機會）
    - 改進選項生成邏輯：先隨機選擇職業，再從職業中選擇選項
  - **UI/UX 修復**：
    - 修復排行榜和遊戲說明按鈕沒反應的問題（添加主選單按鈕事件監聽器）
    - 實作 `updateLeaderboard()` 和 `renderGuidePanel()` 函數
    - 修復遊戲結束時勇者名顯示問題（從 localStorage 讀取並自動填入）
    - 優化遊戲說明的頭像大小和編排（48x48 像素，橫向排列）
  - **道具系統優化**：
    - 根據地圖大小動態計算道具數量（每 400 格一個道具，最少 8 個）
    - 60x60 地圖會有 9 個道具，確保地圖上道具充足

### 技術改進
- **碰撞檢測優化**：
  - 添加碰撞冷卻時間機制，避免頻繁觸發
  - 改進碰撞處理邏輯，確保每次碰撞只處理一次
  - 使用 `for` 循環替代 `forEach`，支持提前跳出
- **傷害系統改進**：
  - 添加傷害間隔機制（法師光環、碰撞檢測）
  - 改進傷害範圍計算（考慮視覺效果和實際判定）
- **視覺效果優化**：
  - 法師光環根據是否有敵人改變亮度和線條粗細
  - 敵人受傷時顯示傷害數字和閃爍效果
  - 改進所有特效的繪製邏輯

### 配置調整
- **法師光環傷害**：
  - 初始值：5 → 3
  - 升級增量：0.5 → 3
- **弓箭手攻擊範圍**：
  - 150 像素（約 3.75 格）→ 280 像素（約 7 格）

## 2025-12-XX（階段版本 v1.0）

### 行動裝置優先重構（Mobile First）
- **重大更新**：全面重構 UI/UX，專為行動裝置優化
- **實作細節**：
  - **統一首頁（主選單）**：
    - 遊戲載入後顯示全螢幕主選單
    - 包含遊戲標題、名字輸入框（自動帶入保存的名字）、三個大按鈕：「開始遊戲」、「排行榜」、「遊戲說明」
    - 背景為遊戲畫面的暗化模糊版
  - **彈窗化（Modals）**：
    - 移除原本的左右側邊欄（`<aside>`）
    - 改為預設隱藏的 Modal 彈跳視窗
    - 點擊主選單的「排行榜」或「遊戲說明」按鈕時顯示對應的 Modal
    - 在遊戲進行中，畫面右上角有暫停、排行榜、遊戲說明三個小圖示按鈕
    - 點擊可暫停遊戲並開啟 Modal
  - **Game Over 畫面調整**：
    - 新增「🔄 重新開始」與「🏠 回主選單」兩個按鈕
    - 重新開始直接重置並開始遊戲
    - 回主選單返回主選單畫面
  - **Canvas 響應式適配**：
    - Canvas 寬度設為 `100%`，高度 `auto`（維持 4:3 比例）
    - 根據視窗大小自動調整，適配不同螢幕尺寸
    - 最大寬度 800px，最大高度 600px
- **流程邏輯**：
  - 初始化時顯示主選單，不自動開始遊戲
  - 點擊「開始遊戲」才開始遊戲
  - Game Over 時可選擇重新開始或回主選單
- **技術改進**：
  - 添加 `resizeCanvas()` 函數動態調整 Canvas 尺寸
  - 監聽視窗大小變化，自動調整遊戲畫面
  - 所有按鈕最小高度 44-48px，符合觸控標準

### 觸控手勢支持
- **新增功能**：支援滑動手勢控制方向
- **實作細節**：
  - 添加 `touchstart` 和 `touchend` 事件監聽
  - 根據 X、Y 軸位移量判斷上下左右方向
  - 邏輯同鍵盤方向鍵（包含防 180 度迴轉）
  - 設定 CSS `touch-action: none` 和 `touch-action: manipulation` 防止滑動時畫面捲動
  - 觸控時間超過 500ms 或移動距離小於 20px 時忽略（避免誤觸）
- **效果**：行動裝置玩家可以使用滑動手勢控制遊戲，無需虛擬按鈕

### 倒數計時功能
- **新增功能**：關閉 Modal 後顯示 3-2-1 倒數計時
- **實作細節**：
  - 關閉暫停、排行榜或遊戲說明 Modal 時，不立即取消暫停
  - 顯示大型倒數數字（3、2、1）覆蓋層
  - 倒數數字有脈衝動畫效果（縮放動畫）
  - 倒數完成後才取消暫停，讓遊戲繼續
  - 倒數期間只繪製畫面，不更新遊戲邏輯
- **效果**：避免關閉 Modal 後立即死亡，給玩家準備時間

### 弓箭碰撞修復
- **調整功能**：弓箭不能穿越隊伍成員和敵人
- **實作細節**：
  - 添加弓箭與隊伍成員的碰撞檢測
  - 弓箭從稍微遠離弓箭手的位置開始發射（偏移距離 `GRID_SIZE * 0.6`），避免立即與發射者碰撞
  - 記錄弓箭的發射者索引，在前 3 幀跳過與發射者的碰撞檢測
  - 弓箭擊中隊伍成員或敵人後立即移除（不能穿透）
- **效果**：弓箭不再過於強大，需要更精準的射擊策略

### 弓箭手升級效果增強
- **調整功能**：「射擊速度」升級同時增加速度和射擊頻率
- **實作細節**：
  - 更新升級描述：「箭矢飛行速度 +{value}，射擊頻率提升」
  - 新增 `getArcherCooldown()` 函數計算升級後的冷卻時間
  - 每級減少 10% 冷卻時間（最多減少到 50%，即冷卻時間減半）
  - 例如：等級 0 = 1000ms，等級 5 = 500ms，等級 10 = 500ms
- **效果**：提升「射擊速度」升級的吸引力，同時增加速度和射擊頻率

### 排行榜上傳邏輯優化
- **調整功能**：優化上傳按鈕顯示邏輯
- **實作細節**：
  - 優先檢查今日排行榜：如果今日排行榜沒有記錄或記錄少於 10 筆，顯示上傳按鈕
  - 如果今日排行榜有 10 筆以上，檢查是否達到第 10 名的擊殺數
  - 如果今日排行榜未達標，再檢查全球排行榜
  - 如果擊殺數為 0（一個敵人都沒殺），不顯示上傳按鈕
- **效果**：更合理的上傳條件判斷，避免無意義的上傳

### 怪物強度調整
- **調整功能**：提高怪物強度對應玩家等級
- **實作細節**：
  - 玩家等級 3-4：等級 1 怪物從 80% 降至 60%，等級 2 怪物從 20% 升至 40%
  - 玩家等級 5-6：完全移除等級 1 怪物，改為等級 2-4 混合
    - 等級 2：50%
    - 等級 3：35%
    - 等級 4：15%
- **配置檔案**：`enemy-spawn-config.js`
- **效果**：怪物強度更符合玩家等級，避免高等級玩家仍遇到過多弱怪

## 2025-12-XX（之前版本）

### 等級與經驗值系統
- **新增功能**：玩家等級和經驗值系統
- **實作細節**：
  - 玩家有等級和經驗值，經驗值滿了會升級
  - 等級和經驗值條顯示在遊戲視窗下方
  - 經驗值來源：擊殺敵人獲得經驗值，不同等級的敵人提供不同經驗值
  - 升級公式：`所需經驗值 = baseExp * (等級 ^ expMultiplier)`
    - `baseExp = 80`：基礎經驗值需求
    - `expMultiplier = 1.3`：經驗值成長倍率
  - 升級時會彈出三選一升級選項供玩家選擇
  - 選擇升級時會鎖血，避免在選擇過程中死亡
- **配置檔案**：`upgrade-config.js`

### 升級三選一系統
- **新增功能**：升級時彈出三選一升級選項
- **實作細節**：
  - 每次升級時隨機生成 3 個升級選項
  - 同職業只會出現一個選項，避免重複
  - 選項顯示名稱、效果、當前 Lv/最大 Lv
  - 選項滿級後，效果統一變成隊長最大HP+1
  - 升級選擇時暫停遊戲邏輯，但繼續繪製
- **升級選項**：
  - **法師**：施法範圍+1（最大Lv8）、施法傷害+1（最大Lv5）
  - **弓箭手**：弓箭數量+1（最大Lv3）、射擊速度+1（最大Lv10）
  - **騎士**：可被攻擊次數+1（最大Lv10）、死亡後增加隊伍長度+1（最大Lv3）
  - **隊長**：血量+5（最大Lv10）、傷害+1（最大Lv5）

### 怪物等級系統重構
- **調整功能**：將怪物系統從強度等級（tier）改為簡單的等級系統（1-10級）
- **實作細節**：
  - 怪物等級範圍：1-10 級
  - 屬性計算公式：
    - 血量：`baseHp + (level - 1) * hpPerLevel`
    - 傷害：`baseDamage + (level - 1) * damagePerLevel`
    - 經驗值：`baseExp * level`
  - 等級顯示：怪物圖片下方顯示白色文字 "Lv1"、"Lv2" 等
  - 移除怪物名稱（普通、精英等），只顯示等級
- **配置檔案**：`upgrade-config.js` 中的 `enemyLevel` 配置

### 怪物生成系統
- **新增功能**：根據玩家等級決定怪物出現機率
- **實作細節**：
  - 一開始只出現等級 1 的怪物（最弱）
  - 隨著玩家等級提升，逐漸出現更強的怪物
  - 每個玩家等級階段定義可出現的怪物等級及其出現機率（權重）
  - 使用權重系統隨機選擇怪物等級
- **配置檔案**：`enemy-spawn-config.js`（獨立配置文件）
- **詳細說明**：參考 `docs/ENEMY-SPAWN-README.md`

### 職業升級效果整合
- **調整功能**：各職業技能會根據升級等級動態調整
- **實作細節**：
  - **弓箭手**：
    - 射擊速度可升級（從射程改為速度）
    - 弓箭數量可升級（每次攻擊可發射多支箭矢）
  - **法師**：
    - 光環範圍可升級
    - 光環傷害可升級
  - **騎士**：
    - 可被攻擊次數可升級（越接近消失越透明，但邊框不透明）
    - 死亡後增加隊伍長度可升級
  - **隊長**：
    - 最大血量可升級
    - 撞擊傷害可升級（預留功能）

### 邊界檢測優化
- **調整功能**：邊界檢測改為完全基於視覺位置來判斷
- **實作細節**：
  - 邏輯位置可以暫時超出邊界，但只有在視覺位置真的超出邊界時才判定死亡
  - 使用角色中心點來判斷，考慮角色大小（`GRID_SIZE / 2`）
  - 在 `gameLoop` 中，在更新視覺位置（lerp）後檢查邊界
  - 避免因平滑移動（lerp）延遲導致的誤判
- **效果**：確保玩家看到的和實際判定完全一致，不會再出現視覺上還沒碰到邊界就判定死亡的情況

### UI 優化
- **新增功能**：等級和經驗值條顯示在遊戲視窗下方
- **調整功能**：Game Over 畫面新增最高等級顯示
- **調整功能**：怪物血量文字只在扣血時短暫顯示
- **調整功能**：怪物等級顯示在圖片下方，格式為 "Lv1"、"Lv2" 等

### 頁面滾動優化
- **調整功能**：修復移動時整個網頁都在動的問題
- **實作細節**：
  - 為 `html` 和 `body` 添加 `overflow-x: hidden` 和 `overflow-y: auto`
  - 為 `.game-wrapper` 添加 `flex-shrink: 0` 和 `margin-bottom`
  - 防止布局跳動

## 2025-11-21

### 排行榜系統優化
- **調整功能**：排行榜分為「全球排行榜」和「今日排行榜」，上下排列顯示
- **實作細節**：
  - 移除切換按鈕，改為同時顯示兩個排行榜卡片
  - 全球排行榜顯示前 5 名（總排行）
  - 今日排行榜顯示前 5 名（當日排行）
  - 使用客戶端過濾方式處理今日排行榜，避免 Firebase 查詢錯誤
  - 查詢所有記錄後，在 JavaScript 中過濾今天的記錄
  - 判斷是否進入前 10 名時，仍使用總排行榜的前 10 名數據
- **技術改進**：
  - 修復 Firebase 查詢錯誤（`where` 不等式過濾與 `orderBy` 衝突）
  - 改為一次性查詢所有記錄，然後在客戶端過濾和排序

### 邊界視覺化
- **新增功能**：繪製邊界線，讓玩家清楚看到遊戲區域邊界
- **實作細節**：
  - 在畫布上繪製白色虛線邊界線（3px 寬）
  - 邊界線對應實際的遊戲區域（`gridWidth * GRID_SIZE`）
  - 幫助玩家判斷是否接近邊界，減少「還沒碰到就死了」的困惑
- **邊界檢測邏輯**：
  - 邊界檢測基於邏輯位置（網格座標），非視覺位置
  - 當 `nextX >= gridWidth` 或 `nextY >= gridHeight` 時觸發遊戲結束
  - 由於平滑移動（lerp），視覺位置可能尚未到達邊界，但邏輯位置已超出

### 角色面向系統調整
- **調整功能**：勇者根據自己的左右位移改變面向，而非跟隨 leader
- **實作細節**：
  - 在 `moveSnake()` 中，每個 segment 根據自己的前後位置更新 `facing`
  - 比較移動前後的 x 座標（`prevX` 和 `currentX`）
  - 如果有左右移動（`currentX !== prevX`），根據移動方向更新 `facing`
  - 如果沒有左右移動（上下移動），保持原來的 `facing` 不變
  - 在 `draw()` 中直接使用 segment 的 `facing`，如果沒有則使用 leader 的 `facing`
- **行為說明**：
  - 當勇者向右移動時，面向右（facing = 1）
  - 當勇者向左移動時，面向左（facing = -1）
  - 當勇者上下移動時，保持原來的面向不變

### 繪製順序優化
- **調整功能**：調整角色和血條的繪製順序，確保正確的階層顯示
- **實作細節**：
  - 角色繪製改為從後往前（從 `snake.length - 1` 到 `0`）
  - 後面的角色先繪製，前面的角色後繪製（前面的會覆蓋後面的）
  - 血條繪製從角色繪製中分離，在所有角色繪製完成後統一繪製
  - 確保血條顯示在最上層，不會被任何角色遮住
- **效果**：
  - Leader 和前面的隊員會顯示在後面的隊員之上
  - 血條永遠顯示在最上層，清晰可見

## 2025-11-21

### 角色面向系統
- **新增功能**：角色會根據移動方向改變面向
  - 向右移動時，所有角色面向右（原本圖片）
  - 向左移動時，所有角色面向左（使用 Canvas `scale(-1, 1)` 翻轉圖片）
  - 向上或向下移動時，保持當前面向不變
- **實作細節**：
  - 新增 `facing` 變數（1 = 向右，-1 = 向左）追蹤隊長面向
  - 在 `moveSnake()` 中，當 `direction.x !== 0` 時更新 `facing`
  - 修改 `createAsset()` 的 `draw()` 方法，接受 `facing` 參數
  - 隊長使用當前的 `facing` 值
  - 其他勇者根據相對於前一個 segment 的位置決定面向（x 座標比較）
  - 當 x 座標相同（上下移動）時，保持前一個 segment 的面向

### 平滑移動系統
- **新增功能**：蛇的移動使用插值平滑化，消除閃爍感
- **實作細節**：
  - 為每個 segment 添加 `renderX` 和 `renderY` 屬性（視覺位置）
  - 邏輯位置（`x`, `y`）立即更新，視覺位置平滑過渡
  - 使用線性插值（Lerp）每幀更新視覺位置，`lerpSpeed = 0.15`
  - 在 `gameLoop()` 中每一幀都執行插值計算
  - 當距離目標位置小於 0.001 時，直接設置為目標位置避免抖動

### 開始畫面與名字管理系統
- **新增功能**：遊戲開始前要求輸入名字，並自動記錄
- **實作細節**：
  - 新增 `startOverlay` 開始畫面，包含名字輸入框和「啟動遊戲」按鈕
  - 開始畫面右側顯示快速指引（使用 `startGuidePanel`）
  - 名字保存到 `localStorage`，下次進入自動使用
  - 如果沒有保存的名字，顯示開始畫面要求輸入
  - 如果有保存的名字，資源載入完成後直接開始遊戲
  - 上傳分數時，如果輸入框為空，自動使用保存的名字
  - 重新開始時，如果沒有名字，會再次顯示開始畫面

### 快速指引配置獨立化
- **新增功能**：快速指引內容獨立為配置文件，方便企劃修改
- **實作細節**：
  - 創建 `guide-config.js` 文件，包含所有快速指引內容
  - 配置結構：`title`、`intro`、`items[]`（每個項目包含 `image`、`alt`、`name`、`description`）、`tip`
  - 新增 `renderGuidePanelContent()` 通用函數渲染指引內容
  - 支援多個面板使用（遊戲中的 `guidePanel` 和開始畫面的 `startGuidePanel`）
  - 創建 `GUIDE-CONFIG-README.md` 說明文件，指導企劃如何修改

### 排行榜優化
- **調整功能**：排行榜改為橫列顯示，移除日期欄位
- **實作細節**：
  - 排行榜項目改為橫列布局：`姓名 | 擊殺數 | 最大隊伍`
  - 使用 `flex-direction: row` 和 `justify-content: space-between`
  - 姓名欄位使用 `flex: 1` 並加入文字溢出處理（`text-overflow: ellipsis`）
  - 擊殺數和最大隊伍使用 `flex-shrink: 0` 保持固定寬度
  - 移除日期顯示相關的 HTML 和 CSS

### 玩家顏色系統（為多玩家預留）
- **新增功能**：每個玩家的所有勇者使用相同顏色邊框
- **實作細節**：
  - 定義 `BORDER_COLORS` 陣列：紅、黃、藍、綠四種顏色
  - 新增 `playerColors` 物件管理不同玩家的顏色
  - 新增 `assignPlayerColor(playerId)` 函數為玩家分配顏色
  - 新增 `getCurrentPlayerColor()` 函數獲取當前玩家顏色
  - 在 `startGame()` 時為當前玩家分配顏色
  - 所有新創建的勇者都使用當前玩家的顏色
  - 為未來的多玩家系統預留機制（最多支援 4 個玩家，每個玩家不同顏色）

### 載入畫面優化
- **調整功能**：載入畫面只覆蓋遊戲畫布，側邊面板在載入時也能顯示
- **實作細節**：
  - 將 `loaderOverlay` 從全屏覆蓋改為只覆蓋 canvas 區域
  - 使用 `position: absolute` 相對於 canvas 容器定位
  - 左側排行榜和右側快速指引在載入時正常顯示
  - 玩家可以在等待載入時閱讀遊戲說明

### 名字本地儲存
- **新增功能**：上傳過的名字會自動記錄，下次遊戲時自動填入
- **實作細節**：
  - 上傳成功後使用 `localStorage.setItem("playerName", name)` 保存
  - 在 `resetUploadForm()` 中從 `localStorage.getItem("playerName")` 讀取
  - 頁面載入時自動讀取並填入輸入框
  - 玩家仍可修改名字，修改後上傳會更新保存值

## 2025-11-20

### 初版釋出
- 建立 Canvas 版本勇者貪食蛇 RPG
- 加入職業系統（弓箭手、法師、騎士）與敵人碰撞邏輯
- 實作道具成長、Game Over 覆蓋層與重新開始流程
- 新增降級圖形機制，確保無圖檔時仍可遊玩

### 血量系統
- 受傷角色才顯示細版血條（綠到紅漸層），避免滿血時佔據畫面
- 隊長導入血量機制：被撞扣血、擊殺敵人回復，讓戰鬥更具容錯與節奏感

### 騎士機制調整
- 騎士調整為全隊守護者：只要仍有騎士，敵人撞到任何隊員都會由騎士代為犧牲；無騎士時才輪到被撞隊員受害

### 擊殺統計
- 新增擊殺計數 UI 與效果，統計所有被擊倒的敵人並同步顯示在 HUD

### UI 改善
- 增加資產載入條、右側快速指南與 Game Over 統計（最長隊伍與擊殺數），改善第一次進入時的理解與回饋

### 專案結構重構
- 為解決本地端 CORS 問題，將所有檔案移回根目錄：`index.html`、`style.css`、`script.js` 與所有圖片檔案直接放在專案根目錄
- 將 Firebase 設定與初始化邏輯完全整合到 `index.html`，移除所有 ES Module 引用，改為使用全局變數暴露
- 清理專案結構：刪除 `public/` 資料夾中的舊檔案

### Firebase 排行榜
- 導入 Firebase Firestore 全球排行榜：Game Over 可輸入名字並上傳分數，左側面板即時顯示前 10 名成績（依擊殺數排序）

## 程式結構說明

### 核心檔案
- **`index.html`**：入口頁面，包含遊戲常數定義、Firebase 初始化、UI 結構
  - 遊戲常數定義在 `<script>` 標籤開頭（`GRID_SIZE`、`GAME_SPEED` 等）
  - Firebase SDK 透過 ES Module 導入，並暴露全局變數給 `script.js` 使用
  - UI 結構包含：遊戲畫布、左側排行榜、右側快速指引、開始畫面、Game Over 覆蓋層
- **`style.css`**：所有樣式定義，包含響應式設計
  - 暗色系主題，配合遊戲風格
  - Flexbox 布局，確保畫布和側邊面板正確排列
  - 排行榜和快速指引面板固定寬度，畫布固定 800x600
- **`script.js`**：遊戲核心邏輯（約 1900 行）
  - 所有遊戲邏輯、UI 管理、Firebase 互動都在此檔案

### 配置檔案
- **`guide-config.js`**：快速指引配置，可獨立修改
  - 結構：`title`、`intro`、`items[]`、`tip`
  - 企劃人員可直接修改此檔案，無需觸碰核心程式碼
- **`upgrade-config.js`**：升級系統配置，可獨立修改
  - 結構：`leveling`、`enemyLevel`、`upgrades`、`maxedOutBonus`
  - 包含等級經驗值、怪物屬性、升級選項等配置
  - 詳細說明請參考 `docs/UPGRADE-SYSTEM-README.md`
- **`enemy-spawn-config.js`**：怪物生成配置，可獨立修改
  - 結構：`spawnByPlayerLevel[]`（根據玩家等級定義怪物出現機率）
  - 詳細說明請參考 `docs/ENEMY-SPAWN-README.md`
- **`docs/GDD.md`**：遊戲設計文件
  - 詳細的遊戲規則、參數、機制說明
- **`docs/CHANGELOG.md`**：本文件
  - 所有更新紀錄和程式結構說明

### 主要變數與狀態（script.js）

#### 遊戲狀態
- `snake[]`：隊伍陣列，每個元素包含 `x`、`y`、`renderX`、`renderY`、`role`、`facing`、`borderColor`、`lastShot` 等
- `enemies[]`：敵人陣列，包含位置、血量、移動狀態等
- `projectiles[]`：投射物陣列（弓箭）
- `effects[]`：特效陣列（爆炸、擊殺、受傷等）
- `item`：當前道具物件（`null` 或包含 `x`、`y`）
- `isGameOver`：遊戲是否結束

#### 移動系統
- `direction`：當前移動方向 `{ x, y }`
- `nextDirection`：下一個移動方向（用於防止 180 度折返）
- `facing`：隊長面向（1 = 向右，-1 = 向左）
- `renderX`、`renderY`：每個 segment 的視覺位置（用於平滑插值）
- `gridWidth`、`gridHeight`：網格寬度和高度（根據畫布大小計算）

#### 玩家系統
- `playerColors`：物件，儲存每個玩家的顏色 `{ playerId: color }`
- `currentPlayerId`：當前玩家 ID（目前固定為 "player1"）
- `currentPlayerColor`：當前玩家的顏色（用於邊框）

#### 計分系統
- `killCount`：擊殺數
- `maxLengthThisRun`：本局最長隊伍長度
- `leaderHP`：隊長當前血量

#### 等級系統
- `playerLevelValue`：玩家當前等級
- `playerExp`：玩家當前經驗值
- `maxLevelThisRun`：本局最高等級
- `gameStartTime`：遊戲開始時間（用於計算怪物等級）

#### 升級系統
- `upgradeLevels`：物件，追蹤各升級的等級
  - `mage.auraRange`、`mage.auraDamage`
  - `archer.arrowCount`、`archer.arrowSpeed`
  - `knight.hitPoints`、`knight.deathBonus`
  - `leader.maxHp`、`leader.damage`
- `isChoosingUpgrade`：是否正在選擇升級（選擇時鎖血）

#### Firebase 相關
- 透過 `window` 物件暴露的全局變數：
  - `window.firebaseDb`：Firestore 資料庫實例
  - `window.firebaseLeaderboardRef`：排行榜集合引用
  - `window.firebaseAddDoc`：添加文件函數
  - `window.firebaseQuery`、`window.firebaseOrderBy`、`window.firebaseLimit`、`window.firebaseGetDocs`、`window.firebaseWhere`：查詢相關函數
  - `window.firebaseReady`：Firebase 是否初始化完成

#### UI 元素引用
- 所有 DOM 元素在檔案開頭統一引用
- 等級系統：`playerLevel`、`expText`、`expBarFill`、`maxLevelValue`
- 升級選擇：`upgradeOverlay`、`upgradeOptions`
- 排行榜：`leaderboardListAll`（全球）、`leaderboardListToday`（今日）
- 開始畫面：`startOverlay`、`startPlayerNameInput`、`startGameBtn`、`startLoader`、`startForm`
- Game Over：`overlay`、`playerNameInput`、`uploadScoreBtn`、`restartBtn`

### 主要函數（script.js）

#### 遊戲循環
- `gameLoop(timestamp)`：主遊戲循環，使用 `requestAnimationFrame`
  - 處理移動時機（`GAME_SPEED` 間隔）
  - 執行平滑插值計算（每幀更新視覺位置）
  - 邊界檢測（基於視覺位置）
  - 更新敵人、投射物、特效
  - 處理碰撞檢測
  - 繪製畫面
- `moveSnake(timestamp)`：移動蛇（隊伍）
  - 更新 leader 位置
  - 更新所有 segment 位置（跟隨前一個）
  - 邊界檢測
  - 碰撞檢測（撞到自己）
  - 根據位移更新每個 segment 的 `facing`
  - 處理道具收集和新勇者加入
- `draw()`：繪製所有遊戲元素
  - 繪製邊界線
  - 繪製道具
  - 繪製角色（從後往前，確保前面的在上層）
  - 繪製血條（最後繪製，確保在最上層）
  - 繪製敵人、投射物、特效

#### 碰撞檢測
- `handleEnemyCollisions()`：處理敵人與隊伍的碰撞
  - 檢查 leader 是否撞到敵人
  - 檢查隊伍成員是否撞到敵人
  - 處理騎士守護機制
- `rectCircleCollide(rect, circle)`：矩形與圓形碰撞檢測
- `handleBodyCollision(enemy, removeSet)`：處理隊伍成員與敵人的碰撞
  - 優先使用騎士代為犧牲
  - 無騎士時移除被撞成員

#### 職業技能
- `handleArcherAttacks(timestamp)`：處理弓箭手攻擊
  - 檢查冷卻時間
  - 尋找最近敵人（無距離限制）
  - 發射箭矢（數量可升級，速度可升級）
- `handleMageAura()`：處理法師光環傷害
  - 對範圍內敵人造成持續傷害（範圍和傷害可升級）
- `damageEnemy(enemy, amount)`：對敵人造成傷害
  - 更新敵人血量
  - 顯示傷害數字
  - 處理擊殺（給予經驗值）
- `getArcherArrowSpeed()`：獲取弓箭手箭矢速度（考慮升級）
- `getArcherArrowCount()`：獲取弓箭手箭矢數量（考慮升級）
- `getMageAuraRadius()`：獲取法師光環範圍（考慮升級）
- `getMageAuraDamage()`：獲取法師光環傷害（考慮升級）
- `getKnightHitPoints()`：獲取騎士可被攻擊次數（考慮升級）
- `getKnightDeathBonus()`：獲取騎士死亡加成（考慮升級）
- `getLeaderMaxHp()`：獲取隊長最大血量（考慮升級）

#### UI 管理
- `renderGuidePanel()`：渲染遊戲中的快速指引面板
- `renderStartGuidePanel()`：渲染開始畫面的快速指引
- `renderGuidePanelContent(panelElement, config)`：通用函數，根據配置渲染指引內容
- `updateLeaderboard()`：更新排行榜（一次性查詢）
  - 查詢所有記錄（按擊殺數排序）
  - 客戶端過濾今日記錄
  - 更新全球排行榜和今日排行榜顯示
- `renderLeaderboardList(listElement, data)`：渲染排行榜列表
- `checkIfInLeaderboard()`：檢查當前分數是否進入前 10 名
  - 決定是否顯示「上傳分數」按鈕
- `handleScoreUpload()`：處理分數上傳
  - 驗證輸入
  - 上傳到 Firebase
  - 更新本地儲存的名字
- `checkAndShowStartScreen()`：檢查並顯示開始畫面
  - 根據 `localStorage` 中是否有名字決定是否顯示

#### 資源管理
- `createAsset(src, fallback)`：創建資產物件
  - 載入圖片
  - 提供 `draw(x, y, size, facing)` 方法
  - 支援圖片翻轉（根據 `facing`）
  - 圖片載入失敗時使用 fallback 函數
- `finishLoadingPhase()`：完成載入階段
  - 隱藏載入畫面
  - 根據是否有保存的名字決定顯示開始畫面或直接開始遊戲

#### 玩家顏色系統
- `assignPlayerColor(playerId)`：為玩家分配顏色
  - 從 `BORDER_COLORS` 中選擇未使用的顏色
- `getCurrentPlayerColor()`：獲取當前玩家顏色
  - 如果沒有分配，自動分配

#### 等級與升級系統
- `addExp(amount)`：添加經驗值
  - 更新經驗值
  - 檢查是否升級
  - 更新 UI
- `checkLevelUp()`：檢查是否升級
  - 計算所需經驗值
  - 如果經驗值足夠，升級並顯示升級選擇
- `updateLevelUI()`：更新等級 UI
  - 更新等級文字
  - 更新經驗值文字和進度條
- `showUpgradeSelection()`：顯示升級選擇
  - 生成三個升級選項
  - 暫停遊戲邏輯
  - 鎖血（避免在選擇過程中死亡）
- `selectUpgrade(option)`：選擇升級
  - 應用升級效果
  - 關閉升級選擇
  - 恢復遊戲邏輯
- `generateUpgradeOptions()`：生成升級選項（三選一，同職業只出現一個）
- `getUpgradedValue(role, key, baseValue)`：獲取升級後的數值

#### 怪物系統
- `calculateEnemyLevel()`：計算敵人等級（根據玩家等級和出現機率）
- `getEnemyLevelConfig(level)`：獲取敵人等級配置（根據等級計算屬性）
- `spawnEnemy()`：生成敵人（根據配置隨機選擇等級）

#### 其他工具函數
- `startGame()`：開始新遊戲
  - 初始化所有遊戲狀態
  - 分配玩家顏色
  - 重置計分和等級
  - 啟動遊戲循環
- `triggerGameOver()`：觸發遊戲結束
  - 更新排行榜
  - 檢查是否進入前 10 名
  - 顯示 Game Over 覆蓋層（包含最高等級）
- `drawHealthBar(x, y, width, height, current, max)`：繪製血條
- `drawFallbackBlock(color, drawFn, x, y, size)`：繪製降級圖形
- `escapeHtml(text)`：轉義 HTML 特殊字符
