# 勇者貪食蛇 RPG – 遊戲設計文件

## 1. 總覽
- **遊戲類型**：結合貪食蛇與隊伍養成的 2D Canvas 小品。
- **目標玩家**：喜歡策略、節奏控制與輕度 RPG 的休閒玩家。
- **核心體驗**：透過控制蛇頭（隊長）在網格上移動，收集勇者、對抗持續追擊的敵人。

## 2. 平台與技術
- **平台**：桌面與行動裝置瀏覽器。
- **主要技術**：HTML5 Canvas + JavaScript requestAnimationFrame。
- **資產策略**：優先載入 PNG，若缺檔則改用 Canvas 色塊與符號。
- **資料儲存**：Firebase Firestore（全球排行榜）、localStorage（玩家名字）。

## 3. 全域常數
```javascript
const GRID_SIZE = 40;       // 單格像素大小
const GAME_SPEED = 180;     // 蛇移動間隔 (ms) - 可通過升級減少
const ENEMY_SPAWN_RATE = 2000; // 敵人生成間隔 (ms)
const ENEMY_SPEED = 1.2;    // 敵人逐幀速度 (px/frame)
const PROJECTILE_SPEED = 5; // 弓箭飛行速度（可升級）
const ATTACK_RANGE = 280;   // 弓箭手攻擊距離（約 7 格）
const AURA_RADIUS = 80;     // 法師光環半徑（可升級）
const AURA_DAMAGE = 3;      // 法師光環初始傷害（可升級，每次 +3）
const AURA_HIT_INTERVAL = 200; // 法師光環傷害間隔 (ms)
const ARROW_DAMAGE = 10;    // 弓箭傷害
const ENEMY_HP = 20;        // 敵人基礎血量（根據等級變化）
const LEADER_MAX_HP = 150;  // 隊長血量上限（可升級）
const LEADER_COLLISION_DAMAGE = 35; // 隊長被撞傷害（根據敵人等級變化）
const LEADER_HEAL_ON_KILL = 10; // 擊殺敵人回復量
const ARCHER_COOLDOWN = 1000; // 弓箭手冷卻 (ms)（可升級）
const COLLISION_COOLDOWN = 300; // 碰撞冷卻時間 (ms)
const BORDER_COLORS = ["#ef4444", "#eab308", "#3b82f6", "#22c55e"]; // 紅、黃、藍、綠
```

## 4. 遊戲循環

### 4.1 輸入處理
- **控制方式**：
  - **鍵盤**：方向鍵 / WASD 控制蛇頭
  - **觸控**：滑動手勢控制方向（上下左右滑動），顯示軌跡線與方向箭頭
  - **滑鼠**：拖曳滑動控制方向，與觸控體驗一致，顯示軌跡線與方向箭頭
- **限制**：禁止 180 度折返（不能直接反向移動）
- **視覺回饋**：滑動時顯示軌跡線和方向箭頭，提供操作反饋

### 4.2 蛇移動系統
- **移動方式**：依 `GAME_SPEED` 網格移動（Grid-based）
- **平滑插值**：使用線性插值（Linear Interpolation）進行視覺位置插值，確保移動均勻流暢
  - 邏輯位置（`x`、`y`）每 `GAME_SPEED` 毫秒更新一次
  - 視覺位置（`renderX`、`renderY`）使用時間基準的線性插值平滑過渡
  - 記錄插值起點（`startRenderX/Y`）和目標位置（`targetRenderX/Y`）
  - 根據時間進度（`moveProgress = timeSinceMove / currentMoveSpeed`）計算當前位置
  - 確保在整個移動間隔內均勻移動，沒有停頓感
- **面向系統**：
  - **隊長**：根據移動方向改變面向（左右移動時更新 `facing`）
  - **勇者**：根據自己的左右位移改變面向
    - 向右移動時面向右（`facing = 1`）
    - 向左移動時面向左（`facing = -1`）
    - 上下移動時保持原來的面向
  - 使用 Canvas `scale(-1, 1)` 實現圖片翻轉
- **成長機制**：吃到道具 +1 長度並加入新職業（隨機從弓箭手、法師、騎士中選擇）
- **邊界檢測**：基於視覺位置來判斷，確保玩家看到的和實際判定一致
  - 邏輯位置可以暫時超出邊界，但只有在視覺位置真的超出邊界時才判定死亡
  - 使用角色中心點來判斷，考慮角色大小（`GRID_SIZE / 2`）
  - 避免因平滑移動（lerp）延遲導致的誤判
  - 在插值後限制 `renderX/Y` 在邊界內，避免視覺不協調
- **視覺邊界**：繪製白色虛線邊界線，幫助玩家判斷是否接近邊界
- **碰撞效果**：
  - **回彈**：碰撞時添加回彈速度（力度 0.3），衰減係數 0.95
  - **受傷閃爍**：碰撞時顯示深紅色閃爍效果（`#8b0000`，60% 不透明度，持續 10 幀）
  - 回彈效果疊加在插值之上，不影響正常移動流暢度

### 4.3 隊長生命系統
- **血量池**：擁有可升級的最大血量（基礎 `LEADER_MAX_HP`）
- **受傷機制**：被敵人直接撞擊扣除傷害（傷害值根據敵人等級而定），但只在血量耗盡才結束遊戲
- **死亡條件**：只在血量歸零時才 Game Over
- **回復機制**：擊殺敵人（遠程、光環或騎士自爆）會回復 `LEADER_HEAL_ON_KILL`
- **升級效果**：
  - **血量**：隊長最大血量增加（基礎 `LEADER_MAX_HP`，最大 Lv10）
  - **傷害**：隊長撞擊敵人傷害增加（最大 Lv5）
- **視覺回饋**：受傷時顯示血條（綠→紅漸層），血滿時不顯示
- **升級鎖血**：選擇升級時會鎖血，避免在選擇過程中死亡

### 4.4 敵人行為
- **生成**：每 `ENEMY_SPAWN_RATE` 在畫面邊界隨機生成
- **移動**：逐幀以 `ENEMY_SPEED` 追蹤蛇頭（實時移動，非網格）
- **碰撞效果**：
  - **回彈**：碰撞時被推開約 50px，並添加回彈速度
  - **緩停**：碰撞後停止移動 12 幀（約 200ms @ 60fps），使用 `stunTimer` 控制
  - **受傷閃爍**：被攻擊時顯示深紫色閃爍效果（`#6b21a8`，70% 不透明度）
- **等級系統**：怪物有 1-8 級（對應 `mob_1.png` 到 `mob_8.png`），等級越高越強
  - **等級顯示**：怪物圖片下方顯示白色文字 "Lv1"、"Lv2" 等
  - **屬性計算**：根據等級計算血量、傷害和經驗值
  - **生成機制**：根據玩家等級決定會出現哪些等級的怪物及其出現機率
    - 一開始只出現等級 1 的怪物（最弱）
    - 隨著玩家等級提升，逐漸出現更強的怪物
    - 配置檔案：`enemy-spawn-config.js`
- **血量顯示**：受傷時顯示血條和傷害數字（HP 60 等），只在扣血時短暫顯示
- **碰撞冷卻**：使用 `COLLISION_COOLDOWN`（300ms）避免頻繁觸發碰撞

### 4.5 職業技能系統

#### 弓箭手 (Archer)
- **攻擊方式**：每 `ARCHER_COOLDOWN` 鎖定最近敵人（距離限制：`ATTACK_RANGE`，約 7 格）
- **投射物**：發射箭矢，速度可升級（基礎 `PROJECTILE_SPEED`），傷害 `ARROW_DAMAGE`
- **升級效果**：
  - **弓箭數量**：每次攻擊可發射多支箭矢（最大 Lv5，從 Lv3 上修）
  - **射擊速度**：箭矢飛行速度提升，同時減少射擊冷卻時間（最大 Lv8，從 Lv10 下修，冷卻時間最多減半）
  - **箭矢爆炸**：命中怪物後對周圍敵人造成傷害（範圍每級+30px，傷害每級+5，最大 Lv5）
  - **必殺 (Critical)**：5%/級機率造成 2 倍傷害，觸發時顯示金色大型文字與特效（最大 Lv10）
- **視覺**：綠色背景，弓箭圖示
- **碰撞**：箭矢不能穿透，擊中敵人後立即移除
- **爆炸效果**：如果升級了爆炸效果，箭矢命中敵人時會對範圍內所有敵人（包括被命中的敵人）造成傷害，並顯示綠色爆炸特效。**注意**：被直接命中的敵人會受到兩次傷害（箭矢傷害 + 爆炸傷害）。

#### 法師 (Mage)
- **攻擊方式**：對光環範圍內敵人造成持續傷害（傷害間隔：`AURA_HIT_INTERVAL` = 200ms）
- **傷害範圍**：考慮光環線條寬度和敵人大小，確保視覺範圍與傷害範圍一致
- **升級效果**：
  - **施法範圍**：光環範圍增加（基礎 `AURA_RADIUS`，最大 Lv8）
  - **施法傷害**：光環傷害增加（基礎 `AURA_DAMAGE` = 3，每次升級 +3，最大 Lv5）
  - **縮放效果**：光環隨時間呼吸式縮放（每級+10%，最大 Lv5）。傷害範圍會與視覺縮放完全同步。
  - **降速光環**：光圈內的敵人速度減少 12%/級（最大Lv5，最高減速 60%）。
- **視覺**：藍色背景，星星圖示，外圈藍色光環特效（範圍會隨升級擴大）
  - 有敵人時光環更亮、線條更粗，提供視覺反饋
  - 縮放效果讓法師有呼吸式的動態感
- **效能優化**：光環直接繪製，不加入 `effects` 陣列，避免效能問題

#### 騎士 (Knight)
- **防禦機制**：敵人碰撞時優先由騎士代為犧牲，可被攻擊次數可升級
- **hitPoints 系統**：騎士有可被攻擊次數（基礎值可升級，最大 Lv5）
  - 每次被撞減少 1 點 hitPoints
  - 根據剩餘 hitPoints 百分比調整透明度（100% 時完全不透明，0% 時 30% 透明）
  - hitPoints 歸零時移除騎士
- **守護機制**：若隊伍仍有騎士，敵人撞到任何隊員（除隊長外）都會由最先的騎士代為犧牲
- **無敵機制**：騎士死亡後觸發全隊無敵（每級 +1秒，最大 Lv5）。無敵期間：
  - 隊長不扣血
  - 隊員不會被移除
  - 騎士不會減少 hitPoints
  - **例外**：撞擊世界邊界依然會死亡
- **升級效果**：
  - **可被攻擊次數**：騎士可承受多次攻擊（初始 1 次，最大 Lv5）
  - **死亡後增加隊伍長度**：騎士死亡時隊伍長度增加（可升級，最大 Lv3）
  - **死亡爆炸**：騎士死亡時爆炸範圍 +40px/級，傷害 +10/級（最大 Lv8）。
  - **無敵**：死亡後全隊無敵 N 秒（最大 Lv5）。
- **視覺**：金色背景，盾牌圖示，根據 hitPoints 百分比顯示透明度
- **無敵視覺**：全隊勇者同步閃爍淺黃色（使用 `lighter` 混合模式，每秒 2 次），隊長頭頂顯示倒數計時，無全屏黃色濾鏡。

### 4.6 碰撞結果
- **敵人撞隊長**：造成 `LEADER_COLLISION_DAMAGE` 傷害，但只在血量耗盡才結束遊戲（無敵期間免疫）。
- **敵人撞隊員（有騎士）**：由最先的騎士代為犧牲並擊殺敵人，觸發爆炸特效（無敵期間免疫）。
- **敵人撞隊員（無騎士）**：移除被撞隊員，敵人繼續存活並追擊（無敵期間免疫）。

### 4.7 等級與經驗值系統
- **等級系統**：玩家有等級和經驗值，經驗值滿了會升級
- **經驗值來源**：擊殺敵人獲得經驗值，不同等級的敵人提供不同經驗值
- **升級公式**：`所需經驗值 = baseExp * (等級 ^ expMultiplier)`
  - `baseExp = 80`：基礎經驗值需求
  - `expMultiplier = 1.3`：經驗值成長倍率
- **等級顯示**：等級和經驗值條顯示在遊戲視窗下方
- **升級選擇**：升級時會彈出三選一升級選項供玩家選擇
- **升級鎖血**：選擇升級時會鎖血，避免在選擇過程中死亡

### 4.8 升級系統
- **三選一機制**：每次升級時隨機生成 3 個升級選項
- **選項規則**：同職業只會出現一個選項，避免重複
- **選項顯示**：顯示名稱、效果、當前 Lv/最大 Lv
- **滿級效果**：選項滿級後，效果統一變成隊長最大HP+1（不計入能力類型）
- **能力類型限制**：
  - 每輪遊戲最多可解鎖 10 種不同的能力類型
  - 能力類型計數器顯示在遊戲界面（「能力類型: X/10」）
  - 達到上限後，未解鎖的選項會變半透明且無法選擇
  - 已解鎖的選項可以繼續升級，不受限制
  - 滿級選擇（隊長最大血量+1）不計入能力類型限制

### 4.9 怪物等級系統
- **等級範圍**：怪物有 1-8 級（對應 `mob_1.png` 到 `mob_8.png`），等級越高越強
- **屬性計算**：
  - **血量**：`baseHp + (level - 1) * hpPerLevel`（等級 1：20 HP，等級 8：160 HP）
  - **傷害**：`baseDamage + (level - 1) * damagePerLevel`（等級 1：35 傷害，等級 8：84 傷害）
  - **經驗值**：`baseExp * level`（等級 1：10 經驗值，等級 8：80 經驗值）
- **等級顯示**：怪物圖片下方顯示白色文字 "Lv1"、"Lv2" 等
- **生成機制**：根據玩家等級決定會出現哪些等級的怪物及其出現機率
  - 一開始只出現等級 1 的怪物
  - 隨著玩家等級提升，逐漸出現更強的怪物
  - 配置檔案：`enemy-spawn-config.js`

### 4.10 得分與統計
- **隊伍長度**：即時顯示在 HUD，等於分數
- **擊殺統計**：累積擊殺數，顯示在 HUD，方便掌握補血進度
- **等級統計**：顯示當前等級和經驗值進度
- **能力類型統計**：顯示已解鎖的能力類型數量（「能力類型: X/10」）
- **最長隊伍**：記錄本局最長隊伍長度，Game Over 時顯示
- **最高等級**：記錄本局最高等級，Game Over 時顯示

### 4.11 測試功能
- **測試修改按鈕**：
  - 位置：遊戲界面能力類型文字最右邊
  - 圖標：🔧（紅色背景，與其他按鈕區分）
  - 功能：點擊後遊戲暫停，彈出密碼輸入框
- **密碼保護**：
  - 密碼：`690630`
  - 支持 Enter 鍵快速確認
  - 密碼錯誤時顯示錯誤提示
  - 右上角 X 按鈕可關閉並恢復遊戲
- **修改視窗**：
  - 列出所有能力選項（按職業分類：隊長、弓箭手、法師、騎士）
  - 顯示職業名稱、能力名稱、描述、當前等級、最大等級
  - 加減按鈕可調整等級（+ / -）
  - **GM 等級同步**：增加能力等級時，會自動提升玩家等級以匹配總能力等級，並相應提高怪物強度。
  - 能力類型達上限時，未解鎖選項變半透明且無法點擊
  - 實時更新能力類型計數器
  - 右上角 X 按鈕可關閉並恢復遊戲
- **用途**：方便測試各種能力組合，驗證遊戲平衡性

## 9. 技術架構

### 9.1 檔案結構
```
HeroSnakeRPG/
├── index.html              # 入口頁面，包含常數定義和 Firebase 初始化
├── style.css               # 所有樣式定義
├── script.js               # 遊戲核心邏輯（約 1900 行）
├── guide-config.js         # 快速指引配置（可獨立修改）
├── upgrade-config.js       # 升級系統配置（可獨立修改）
├── enemy-spawn-config.js   # 怪物生成配置（可獨立修改）
├── *.png                   # 角色與道具圖片（根目錄）
├── docs/
│   ├── GDD.md              # 遊戲設計文件（本文件）
│   ├── CHANGELOG.md        # 更新紀錄
│   ├── TECHNICAL-NOTES.md  # 技術筆記與 AI 開發導讀
│   ├── UPGRADE-SYSTEM-README.md    # 升級系統配置說明
│   └── ENEMY-SPAWN-README.md       # 怪物生成配置說明
└── GUIDE-CONFIG-README.md  # 指引配置說明
```
