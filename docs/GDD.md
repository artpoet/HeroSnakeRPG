# 勇者貪食蛇 RPG – 遊戲設計文件

## 1. 總覽
- **遊戲類型**：結合貪食蛇與隊伍養成的 2D Canvas 小品。
- **目標玩家**：喜歡策略、節奏控制與輕度 RPG 的休閒玩家。
- **核心體驗**：透過控制蛇頭（隊長）在網格上移動，收集勇者、對抗持續追擊的敵人。

## 2. 平台與技術
- **平台**：桌面與行動裝置瀏覽器。
- **主要技術**：HTML5 Canvas + JavaScript requestAnimationFrame。
- **資產策略**：優先載入 PNG，若缺檔則改用 Canvas 色塊與符號。
- **資料儲存**：Firebase Firestore（全球排行榜）、localStorage（玩家名字）。

## 3. 全域常數
```javascript
const GRID_SIZE = 40;       // 單格像素大小
const GAME_SPEED = 230;     // 蛇移動間隔 (ms) - v1.4.1 調整為 230
const ENEMY_SPAWN_RATE = 2000; // 敵人生成間隔 (ms)
const ENEMY_SPEED = 1.0;    // 敵人基礎逐幀速度 (px/frame) - v1.4.1 調整為 1.0
const PROJECTILE_SPEED = 5; // 弓箭飛行速度（可升級）
const ATTACK_RANGE = 320;   // 弓箭手攻擊距離（約 8 格，射擊距離與瞄準距離相同）
const AURA_RADIUS = 80;     // 法師光環半徑（可升級）
const AURA_DAMAGE = 3;      // 法師光環初始傷害（可升級，每次 +5）
const ARROW_DAMAGE = 5;     // 弓箭傷害
const ENEMY_HP = 20;        // 敵人基礎血量（根據等級變化）
const LEADER_MAX_HP = 150;  // 隊長血量上限（可升級）
const LEADER_COLLISION_DAMAGE = 35; // 隊長被撞傷害（根據敵人等級變化）
const LEADER_HEAL_ON_KILL = 10; // 擊殺敵人回復量
const COLLISION_COOLDOWN = 500; // 碰撞冷卻時間 (ms) - v1.4.0 調整為 500
```

## 4. 遊戲循環

### 4.1 輸入處理
- **控制方式**：鍵盤（方向鍵/WASD）、觸控滑動、滑鼠拖曳。
- **限制**：禁止 180 度折返（不能直接反向移動）。
- **視覺回饋**：滑動時顯示軌跡線和方向箭頭。

### 4.2 蛇移動系統
- **移動方式**：依 `GAME_SPEED` 網格移動（Grid-based）。
- **平滑插值**：使用線性插值（Linear Interpolation）進行視覺位置插值，確保移動均勻流暢。
- **死亡處理**：
  - **撞牆**：立即觸發死亡，**不回彈**，玩家停在撞擊前的位置。
  - **撞自己**：經典貪食蛇死亡。
  - **撞石頭**：新障礙物，撞到即死。
- **死亡動畫**：
  - 玩家死亡後進入約 1 秒的 `isPlayerDying` 狀態。
  - 遊戲邏輯暫停（怪不動、蛇不動）。
  - 隊長變紅並播放像素崩解特效 (`player-disintegrate`)。
  - 1 秒後才顯示 Game Over 視窗。

### 4.3 隊長生命系統
- **血量池**：擁有可升級的最大血量（基礎 150）。
- **升級效果**：
  - **血量**：隊長最大血量額外增加（每次 +10）。
  - **傷害**：隊長撞擊敵人傷害增加（每次 +10）。
  - **移動速度**：減少移動間隔。

### 4.4 敵人行為
- **移動**：逐幀追蹤蛇頭，速度隨等級提升。
- **碰撞檢測**：
  - 與玩家：每 500ms 最多觸發一次傷害。
  - 與石頭：會被石頭阻擋並輕微彈開（有冷卻時間）。
- **等級系統**：Lv1-8，數值指數成長。

### 4.5 勇者合成與升級系統
- **合成機制**：連續同職業同等級勇者自動合成（3->1, 4->1, 5->1）。
- **數值成長**：
  - **弓箭手**：傷害線性成長。
  - **法師**：傷害倍數成長。
  - **騎士**：HP 倍數成長。

### 4.6 職業技能系統

#### 弓箭手 (Archer)
- **攻擊**：發射箭矢，撞到石頭消失。
- **升級**：弓箭數量、射擊速度、箭矢爆炸、致命一擊。

#### 法師 (Mage)
- **攻擊**：光環持續傷害。
- **升級**：施法範圍、施法傷害（每次 +5，最大 Lv8）、縮放效果、降速光環。

#### 騎士 (Knight)
- **防禦**：代為承受傷害，HP 歸零死亡。
- **無敵機制 (重要)**：
  - 騎士受傷後觸發全隊無敵（4秒）。
  - **隊伍級判定**：無敵期間，**所有敵人**無法對**任何隊員**造成傷害。
- **升級**：
  - **擊殺回血**：殺怪回血。
  - **榮譽號召**：騎士死亡時招募 X 名勇者。
  - **傷害反震**：受傷時對周圍造成傷害。
  - **聖光庇護**：增加無敵持續時間。

### 4.7 障礙物系統 (Obstacles)
- **生成**：玩家每升一級，生成 3 個石頭。
- **保護期**：生成後 2 秒內半透明、無碰撞，避免生成殺。
- **特性**：
  - 阻擋玩家（撞死）。
  - 阻擋怪物（彈開）。
  - 阻擋弓箭（消失）。
- **視覺**：灰色方塊，紅色描邊。

### 4.8 升級與能力限制
- **三選一**：每次升級隨機 3 個選項。
- **能力上限**：最多解鎖 8 種能力類型。
- **加權隨機**：已解鎖的能力更容易出現。

### 4.9 視覺特效系統
- **特效類型**：
  - `knight-explosion`：金色/紅色爆炸光圈。
  - `member-death`：深紅色血霧擴散（隊員死亡）。
  - `player-disintegrate`：紅色像素方塊飛散（隊長死亡）。
  - `obstacle-spawn`：灰色閃光（石頭生成）。
- **安全機制**：所有特效繪製時均有半徑保護，防止數值錯誤導致崩潰。
