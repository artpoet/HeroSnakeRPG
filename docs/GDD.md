# 勇者貪食蛇 RPG – 遊戲設計文件

## 1. 總覽
- **遊戲類型**：結合貪食蛇與隊伍養成的 2D Canvas 小品。
- **目標玩家**：喜歡策略、節奏控制與輕度 RPG 的休閒玩家。
- **核心體驗**：透過控制蛇頭（隊長）在網格上移動，收集勇者、對抗持續追擊的敵人。

## 2. 平台與技術
- **平台**：桌面與行動裝置瀏覽器。
- **主要技術**：HTML5 Canvas + JavaScript requestAnimationFrame。
- **資產策略**：優先載入 PNG，若缺檔則改用 Canvas 色塊與符號。
- **資料儲存**：Firebase Firestore（全球排行榜）、localStorage（玩家名字）。

## 3. 全域常數
```javascript
const GRID_SIZE = 40;       // 單格像素大小
const GAME_SPEED = 150;     // 蛇移動間隔 (ms)
const ENEMY_SPAWN_RATE = 2000; // 敵人生成間隔 (ms)
const ENEMY_SPEED = 1.5;    // 敵人逐幀速度 (px/frame)
const PROJECTILE_SPEED = 5; // 弓箭飛行速度
const ATTACK_RANGE = 300;   // 弓箭手攻擊距離
const AURA_RADIUS = 80;     // 法師光環半徑
const AURA_DAMAGE = 0.5;    // 法師光環每幀傷害
const ARROW_DAMAGE = 10;    // 弓箭傷害
const ENEMY_HP = 20;        // 敵人血量
const LEADER_MAX_HP = 150;  // 隊長血量上限
const LEADER_COLLISION_DAMAGE = 35; // 隊長被撞傷害
const LEADER_HEAL_ON_KILL = 10; // 擊殺敵人回復量
const ARCHER_COOLDOWN = 1000; // 弓箭手冷卻 (ms)
const BORDER_COLORS = ["#ef4444", "#eab308", "#3b82f6", "#22c55e"]; // 紅、黃、藍、綠
```

## 4. 遊戲循環

### 4.1 輸入處理
- **控制方式**：方向鍵 / WASD 控制蛇頭
- **限制**：禁止 180 度折返（不能直接反向移動）

### 4.2 蛇移動系統
- **移動方式**：依 `GAME_SPEED` 網格移動（Grid-based）
- **平滑插值**：使用 `renderX` 和 `renderY` 進行視覺位置插值，消除閃爍
  - 邏輯位置（`x`、`y`）立即更新
  - 視覺位置（`renderX`、`renderY`）使用線性插值平滑過渡
  - `lerpSpeed = 0.15`，每幀更新視覺位置
- **面向系統**：
  - **隊長**：根據移動方向改變面向（左右移動時更新 `facing`）
  - **勇者**：根據自己的左右位移改變面向
    - 向右移動時面向右（`facing = 1`）
    - 向左移動時面向左（`facing = -1`）
    - 上下移動時保持原來的面向
  - 使用 Canvas `scale(-1, 1)` 實現圖片翻轉
- **成長機制**：吃到道具 +1 長度並加入新職業（隨機從弓箭手、法師、騎士中選擇）
- **邊界檢測**：基於視覺位置來判斷，確保玩家看到的和實際判定一致
  - 邏輯位置可以暫時超出邊界，但只有在視覺位置真的超出邊界時才判定死亡
  - 使用角色中心點來判斷，考慮角色大小（`GRID_SIZE / 2`）
  - 避免因平滑移動（lerp）延遲導致的誤判
- **視覺邊界**：繪製白色虛線邊界線，幫助玩家判斷是否接近邊界

### 4.3 隊長生命系統
- **血量池**：擁有可升級的最大血量（基礎 `LEADER_MAX_HP`）
- **受傷機制**：被敵人直接撞擊扣除傷害（傷害值根據敵人等級而定），但只在血量耗盡才結束遊戲
- **死亡條件**：只在血量歸零時才 Game Over
- **回復機制**：擊殺敵人（遠程、光環或騎士自爆）會回復 `LEADER_HEAL_ON_KILL`
- **升級效果**：
  - **血量**：隊長最大血量增加（基礎 `LEADER_MAX_HP`，最大 Lv10）
  - **傷害**：隊長撞擊敵人傷害增加（最大 Lv5）
- **視覺回饋**：受傷時顯示血條（綠→紅漸層），血滿時不顯示
- **升級鎖血**：選擇升級時會鎖血，避免在選擇過程中死亡

### 4.4 敵人行為
- **生成**：每 `ENEMY_SPAWN_RATE` 在畫面邊界隨機生成
- **移動**：逐幀以 `ENEMY_SPEED` 追蹤蛇頭（實時移動，非網格）
- **等級系統**：怪物有 1-10 級，等級越高越強
  - **等級顯示**：怪物圖片下方顯示白色文字 "Lv1"、"Lv2" 等
  - **屬性計算**：根據等級計算血量、傷害和經驗值
  - **生成機制**：根據玩家等級決定會出現哪些等級的怪物及其出現機率
    - 一開始只出現等級 1 的怪物（最弱）
    - 隨著玩家等級提升，逐漸出現更強的怪物
    - 配置檔案：`enemy-spawn-config.js`
- **血量顯示**：受傷時顯示血條和傷害數字（HP 60 等），只在扣血時短暫顯示

### 4.5 職業技能系統

#### 弓箭手 (Archer)
- **攻擊方式**：每 `ARCHER_COOLDOWN` 鎖定最近敵人（無距離限制）
- **投射物**：發射箭矢，速度可升級（基礎 `PROJECTILE_SPEED`），傷害 `ARROW_DAMAGE`
- **升級效果**：
  - **弓箭數量**：每次攻擊可發射多支箭矢（最大 Lv3）
  - **射擊速度**：箭矢飛行速度提升（最大 Lv10）
- **視覺**：綠色背景，弓箭圖示

#### 法師 (Mage)
- **攻擊方式**：對光環範圍內敵人每幀造成傷害
- **升級效果**：
  - **施法範圍**：光環範圍增加（基礎 `AURA_RADIUS`，最大 Lv8）
  - **施法傷害**：光環每幀傷害增加（基礎 `AURA_DAMAGE`，最大 Lv5）
- **視覺**：藍色背景，星星圖示，外圈藍色光環特效（範圍會隨升級擴大）

#### 騎士 (Knight)
- **防禦機制**：敵人碰撞時同歸於盡，附帶爆炸特效
- **守護機制**：若隊伍仍有騎士，敵人撞到任何隊員（除隊長外）都會由最先的騎士代為犧牲
- **升級效果**：
  - **可被攻擊次數**：騎士可承受多次攻擊（初始 1 次，最大 Lv10）
    - 越接近消失會依照比例越來越透明，但邊框不會跟著透明
  - **死亡後增加隊伍長度**：騎士死亡時隊伍長度增加（最大 Lv3）
- **視覺**：黃色背景，盾牌圖示，可被攻擊次數減少時會變透明

### 4.6 碰撞結果
- **敵人撞隊長**：造成 `LEADER_COLLISION_DAMAGE` 傷害，但只在血量耗盡才結束遊戲
- **敵人撞隊員（有騎士）**：由最先的騎士代為犧牲並擊殺敵人，觸發爆炸特效
- **敵人撞隊員（無騎士）**：移除被撞隊員，敵人繼續存活並追擊

### 4.7 等級與經驗值系統
- **等級系統**：玩家有等級和經驗值，經驗值滿了會升級
- **經驗值來源**：擊殺敵人獲得經驗值，不同等級的敵人提供不同經驗值
- **升級公式**：`所需經驗值 = baseExp * (等級 ^ expMultiplier)`
  - `baseExp = 80`：基礎經驗值需求
  - `expMultiplier = 1.3`：經驗值成長倍率
- **等級顯示**：等級和經驗值條顯示在遊戲視窗下方
- **升級選擇**：升級時會彈出三選一升級選項供玩家選擇
- **升級鎖血**：選擇升級時會鎖血，避免在選擇過程中死亡

### 4.8 升級系統
- **三選一機制**：每次升級時隨機生成 3 個升級選項
- **選項規則**：同職業只會出現一個選項，避免重複
- **選項顯示**：顯示名稱、效果、當前 Lv/最大 Lv
- **滿級效果**：選項滿級後，效果統一變成隊長最大HP+1
- **升級選項**：
  - **法師**：施法範圍+1（最大Lv8）、施法傷害+1（最大Lv5）
  - **弓箭手**：弓箭數量+1（最大Lv3）、射擊速度+1（最大Lv10）
  - **騎士**：可被攻擊次數+1（最大Lv10）、死亡後增加隊伍長度+1（最大Lv3）
  - **隊長**：血量+5（最大Lv10）、傷害+1（最大Lv5）

### 4.9 怪物等級系統
- **等級範圍**：怪物有 1-10 級，等級越高越強
- **屬性計算**：
  - **血量**：`baseHp + (level - 1) * hpPerLevel`（等級 1：20 HP，等級 10：200 HP）
  - **傷害**：`baseDamage + (level - 1) * damagePerLevel`（等級 1：35 傷害，等級 10：98 傷害）
  - **經驗值**：`baseExp * level`（等級 1：10 經驗值，等級 10：100 經驗值）
- **等級顯示**：怪物圖片下方顯示白色文字 "Lv1"、"Lv2" 等
- **生成機制**：根據玩家等級決定會出現哪些等級的怪物及其出現機率
  - 一開始只出現等級 1 的怪物
  - 隨著玩家等級提升，逐漸出現更強的怪物
  - 配置檔案：`enemy-spawn-config.js`

### 4.10 得分與統計
- **隊伍長度**：即時顯示在 HUD，等於分數
- **擊殺統計**：累積擊殺數，顯示在 HUD，方便掌握補血進度
- **等級統計**：顯示當前等級和經驗值進度
- **最長隊伍**：記錄本局最長隊伍長度，Game Over 時顯示
- **最高等級**：記錄本局最高等級，Game Over 時顯示

### 4.8 玩家顏色系統（為多玩家預留）
- **顏色分配**：每個玩家的所有勇者使用相同顏色邊框
- **顏色池**：紅、黃、藍、綠四種顏色
- **分配機制**：自動為玩家分配未使用的顏色，最多支援 4 個玩家
- **視覺**：每個勇者周圍有 3px 寬的顏色邊框

## 5. 資源與視覺

### 5.1 角色資源
| 名稱 | 檔名 | 降級顯示 | 備註 |
| --- | --- | --- | --- |
| 隊長 | `leader.png` | 紅色方塊＋皇冠符號 | 可面向左右 |
| 弓箭手 | `archer.png` | 綠底、弓箭線條 | 可面向左右 |
| 法師 | `mage.png` | 藍底、星形、外圈光環 | 可面向左右 |
| 騎士 | `knight.png` | 黃底、盾牌 | 可面向左右 |
| 敵人 | `enemy.png` | 淺灰底、深色核心 | 圓形，實時移動 |
| 道具 | `item.png` | 紫色圓形 | 招募新勇者 |

### 5.2 視覺特效
- **血條**：受傷時顯示，綠→紅漸層，高度 3-4px
- **傷害數字**：敵人受傷時顯示黃色數字
- **爆炸特效**：騎士犧牲或敵人死亡時顯示
- **光環特效**：法師周圍藍色光環
- **擊殺特效**：擊殺敵人時顯示金色光效

## 6. UI 與流程

### 6.1 開始畫面
- **觸發條件**：第一次進入或沒有保存的名字
- **功能**：
  - 輸入玩家名字
  - 右側顯示快速指引
  - 「啟動遊戲」按鈕
- **名字管理**：名字保存到 `localStorage`，下次自動使用

### 6.2 遊戲畫面
- **HUD**：標題、隊伍長度、擊殺計數
- **等級系統**：等級和經驗值條顯示在遊戲視窗下方
  - 顯示當前等級
  - 顯示經驗值進度條（綠色漸層）
  - 顯示經驗值文字（當前經驗值 / 所需經驗值）
- **Canvas**：800×600 暗色背景、霓虹邊框
- **左側排行榜**：即時顯示前 5 名成績（橫列：姓名 | 擊殺數 | 最大隊伍）
  - 分為「全球排行榜」和「今日排行榜」兩個面板
- **右側快速指引**：常駐圖文面板，介紹各職業、敵人與道具
- **載入畫面**：只覆蓋 Canvas 區域，側邊面板在載入時也能顯示
- **升級選擇**：升級時彈出三選一升級選項，暫停遊戲邏輯

### 6.3 Game Over 畫面
- **顯示內容**：
  - 「Game Over」標題
  - 本局最長隊伍長度
  - 總擊殺數
  - 最高等級
  - 名字輸入框（自動填入保存的名字）
  - 「上傳分數」按鈕
  - 「重新開始」按鈕
- **上傳機制**：
  - 如果輸入框為空，自動使用保存的名字
  - 上傳成功後更新保存的名字
  - 上傳到 Firebase Firestore

### 6.4 全球排行榜
- **資料結構**：
  - `name`：玩家名字
  - `score`：最長隊伍長度
  - `kills`：擊殺數
  - `date`：上傳日期（ISO 字串）
- **排序方式**：依擊殺數降序排列
- **顯示方式**：
  - 分為「全球排行榜」和「今日排行榜」兩個面板，上下排列
  - 每個排行榜顯示前 5 名
  - 橫列顯示：`姓名 | 擊殺數 | 最大隊伍`
  - 使用一次性查詢（`getDocs`），在頁面載入、遊戲重啟、上傳成功時更新
  - 今日排行榜使用客戶端過濾（查詢所有記錄後過濾今天的記錄）
- **上傳機制**：
  - 只有當前分數進入前 10 名時才顯示「上傳分數」按鈕
  - 上傳成功後自動保存名字到 `localStorage`

## 7. 配置系統

### 7.1 快速指引配置
- **檔案**：`guide-config.js`
- **結構**：
  ```javascript
  window.GUIDE_CONFIG = {
    title: "快速指引",
    intro: "說明文字",
    items: [
      {
        image: "leader.png",
        alt: "隊長圖示",
        name: "隊長",
        description: "說明文字"
      },
      // ...
    ],
    tip: "操作提示"
  };
  ```
- **用途**：企劃人員可直接修改此檔案更新遊戲說明

### 7.2 升級系統配置
- **檔案**：`upgrade-config.js`
- **內容**：
  - 等級與經驗值系統參數
  - 怪物等級系統參數
  - 各職業升級選項配置
  - 滿級後統一效果配置
- **用途**：企劃人員可直接修改此檔案調整升級平衡
- **詳細說明**：參考 `docs/UPGRADE-SYSTEM-README.md`

### 7.3 怪物生成配置
- **檔案**：`enemy-spawn-config.js`
- **內容**：
  - 根據玩家等級定義怪物出現機率
  - 每個玩家等級階段可出現的怪物等級及其權重
- **用途**：企劃人員可直接修改此檔案調整怪物出現機率
- **詳細說明**：參考 `docs/ENEMY-SPAWN-README.md`

### 7.4 遊戲常數配置
- **位置**：`index.html` 的 `<script>` 標籤內
- **可調整參數**：所有 `GRID_SIZE`、`GAME_SPEED` 等常數

## 8. 平衡調整指南
- **覺得太難**：
  - 增大 `GAME_SPEED`（讓蛇走慢點）
  - 增大 `ENEMY_SPAWN_RATE`（讓敵人少點）
  - 降低 `ENEMY_SPEED`（讓敵人走慢點）
  - 提高 `ARROW_DAMAGE` 或 `AURA_DAMAGE`（增強火力）
- **覺得太簡單**：
  - 反向調整上述參數
  - 減少 `GRID_SIZE`（地圖變大，操作更精細但更難）
- **血量調整**：
  - 增加 `LEADER_MAX_HP`（更容錯）
  - 減少 `LEADER_COLLISION_DAMAGE`（受傷更輕）
  - 增加 `LEADER_HEAL_ON_KILL`（回復更多）

## 9. 技術架構

### 9.1 檔案結構
```
HeroSnakeRPG/
├── index.html              # 入口頁面，包含常數定義和 Firebase 初始化
├── style.css               # 所有樣式定義
├── script.js               # 遊戲核心邏輯（約 1900 行）
├── guide-config.js         # 快速指引配置（可獨立修改）
├── upgrade-config.js       # 升級系統配置（可獨立修改）
├── enemy-spawn-config.js   # 怪物生成配置（可獨立修改）
├── *.png                   # 角色與道具圖片（根目錄）
├── docs/
│   ├── GDD.md              # 遊戲設計文件（本文件）
│   ├── CHANGELOG.md        # 更新紀錄
│   ├── UPGRADE-SYSTEM-README.md    # 升級系統配置說明
│   └── ENEMY-SPAWN-README.md       # 怪物生成配置說明
└── GUIDE-CONFIG-README.md  # 指引配置說明
```

### 9.2 核心變數
- **遊戲狀態**：`snake[]`、`enemies[]`、`projectiles[]`、`effects[]`、`item`、`isGameOver`
- **移動系統**：`direction`、`nextDirection`、`facing`、`renderX/renderY`
- **玩家系統**：`playerColors`、`currentPlayerId`、`currentPlayerColor`
- **計分系統**：`killCount`、`maxLengthThisRun`、`leaderHP`
- **等級系統**：`playerLevelValue`、`playerExp`、`maxLevelThisRun`、`gameStartTime`
- **升級系統**：`upgradeLevels`、`isChoosingUpgrade`

### 9.3 主要函數
- **遊戲循環**：`gameLoop()`、`moveSnake()`、`draw()`
- **碰撞檢測**：`handleEnemyCollisions()`、`rectCircleCollide()`、邊界檢測（基於視覺位置）
- **職業技能**：`handleArcherAttacks()`、`handleMageAura()`、`getArcherArrowSpeed()`、`getMageAuraRadius()`、`getMageAuraDamage()`、`getKnightHitPoints()`、`getKnightDeathBonus()`
- **等級系統**：`addExp()`、`checkLevelUp()`、`updateLevelUI()`、`showUpgradeSelection()`、`selectUpgrade()`
- **怪物系統**：`calculateEnemyLevel()`、`getEnemyLevelConfig()`、`spawnEnemy()`
- **UI 管理**：`renderGuidePanel()`、`updateLeaderboard()`、`handleScoreUpload()`
- **資源管理**：`createAsset()`、`finishLoadingPhase()`

## 10. 後續規劃
- 新敵人種類（射手、衝刺者）
- 隊伍職業升級系統
- 道具池擴充（瞬移、護盾）
- 多玩家連線對戰（已預留顏色系統）
- 角色技能樹系統
