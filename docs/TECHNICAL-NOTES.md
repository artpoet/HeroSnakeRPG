# æŠ€è¡“ç­†è¨˜èˆ‡ç¶“é©—

æœ¬æ–‡ä»¶è¨˜éŒ„é–‹ç™¼éç¨‹ä¸­é‡åˆ°çš„é‡è¦æŠ€è¡“å•é¡Œã€è§£æ±ºæ–¹æ¡ˆå’Œç¶“é©—æ•™è¨“ã€‚

## ğŸ¤– AI å°è®€èˆ‡é–‹ç™¼æ³¨æ„äº‹é … (AI Context & Pitfalls)

**çµ¦æœªä¾†çš„ AI é–‹ç™¼è€…**ï¼šæœ¬å°ˆæ¡ˆæ˜¯åŸºæ–¼ HTML5 Canvas çš„è¼•é‡ç´š RPGï¼Œé›–ç„¶ç¨‹å¼ç¢¼ä¸é•·ï¼Œä½†æœ‰å¹¾å€‹æ ¸å¿ƒæ©Ÿåˆ¶æ¥µæ˜“å‡ºéŒ¯ã€‚è«‹åœ¨ä¿®æ”¹å‰ä»”ç´°é–±è®€ä»¥ä¸‹é‡é»ã€‚

### 1. ç³»çµ±æ¶æ§‹æ ¸å¿ƒ
- **å‡ç´šç³»çµ±æ˜¯æ ¸å¿ƒ**ï¼šæ‰€æœ‰æ•¸å€¼ï¼ˆå‚·å®³ã€ç¯„åœã€é€Ÿåº¦ï¼‰éƒ½æ‡‰å¾ `upgrade-config.js` è®€å–ï¼Œ**çµ•å°ä¸è¦**åœ¨ `script.js` ç¡¬ç·¨ç¢¼æ•¸å€¼ã€‚
- **GM æ¸¬è©¦å·¥å…·**ï¼š`syncPlayerLevelWithUpgrades()` æ˜¯ä¸€å€‹é—œéµå‡½æ•¸ï¼Œå®ƒå°‡ã€Œèƒ½åŠ›ç¸½ç­‰ç´šã€èˆ‡ã€Œç©å®¶ç­‰ç´šã€ç¶å®šã€‚ä¿®æ”¹å‡ç´šé‚è¼¯æ™‚ï¼Œå‹™å¿…ç¢ºèªæ­¤åŒæ­¥æ©Ÿåˆ¶æ˜¯å¦å—åˆ°å½±éŸ¿ã€‚
- **åº§æ¨™ç³»çµ±**ï¼š
  - **é‚è¼¯åº§æ¨™**ï¼š`s.x`, `s.y`ï¼ˆç¶²æ ¼åº§æ¨™ï¼Œæ•´æ•¸ï¼‰ã€‚
  - **è¦–è¦ºåº§æ¨™**ï¼š`s.renderX`, `s.renderY`ï¼ˆåƒç´ åº§æ¨™ï¼Œæµ®é»æ•¸ï¼Œç”¨æ–¼å¹³æ»‘ç§»å‹•ï¼‰ã€‚
  - **ç¢°æ’æª¢æ¸¬**ï¼šå¤§éƒ¨åˆ†åŸºæ–¼**é‚è¼¯åº§æ¨™**æˆ–**ä¸­å¿ƒé»åƒç´ è·é›¢**ã€‚ä¿®æ”¹ç¢°æ’é‚è¼¯æ™‚è¦å°å¿ƒå€åˆ†ã€‚

### 2. å®¹æ˜“å‡ºéŒ¯çš„é™·é˜± (Pitfalls)
- **âŒ é›™é‡å‚·å®³é‚è¼¯**ï¼šå¼“ç®­çˆ†ç‚¸ç¾åœ¨æœƒå°ã€Œè¢«æ“Šä¸­çš„ç›®æ¨™ã€é€ æˆ**å…©æ¬¡å‚·å®³**ï¼ˆç®­çŸ¢æœ¬èº« + çˆ†ç‚¸ï¼‰ã€‚é€™æ˜¯æœ‰æ„ç‚ºä¹‹çš„æ©Ÿåˆ¶ï¼Œè«‹å‹¿ä¿®å¾©æ­¤ã€ŒBugã€ã€‚
- **âŒ æ¸²æŸ“é †åº**ï¼š`draw()` å‡½æ•¸ä¸­çš„ç¹ªè£½é †åºè‡³é—œé‡è¦ã€‚é™°å½± -> æœ¬é«” -> å…‰ç’° -> æŠ•å°„ç‰© -> UIã€‚é¡›å€’é †åºæœƒå°è‡´è¦–è¦ºéŒ¯èª¤ï¼ˆä¾‹å¦‚å…‰ç’°è“‹ä½ç©å®¶ï¼‰ã€‚
- **âŒ ç„¡æ•µæ•ˆæœæ•ˆèƒ½**ï¼šç„¡æ•µé–ƒçˆä½¿ç”¨ `globalCompositeOperation = "lighter"`ã€‚é€™å€‹æ“ä½œéå¸¸è€—æ•ˆèƒ½ï¼Œ**çµ•å°ä¸è¦**åœ¨æ¯ä¸€å¹€å°å…¨å±ä½¿ç”¨ã€‚ç›®å‰çš„å¯¦ä½œæ˜¯åªå°ã€Œç©å®¶ Spriteã€ä½¿ç”¨ï¼Œä¸”é™åˆ¶é »ç‡ï¼ˆæ¯ç§’ 2 æ¬¡ï¼‰ã€‚
- **âŒ é™£åˆ—æ“ä½œ**ï¼šåœ¨éæ­· `snake` æˆ– `enemies` é™£åˆ—æ™‚é€²è¡Œ `splice` ç§»é™¤å…ƒç´ æ¥µæ˜“å°è‡´ç´¢å¼•éŒ¯èª¤æˆ–é–ƒçˆã€‚è«‹ä½¿ç”¨å€’åºéæ­·æˆ–æ¨™è¨˜ç§»é™¤æ³•ã€‚

### 3. é—œéµæ©Ÿåˆ¶å¯¦ä½œç´°ç¯€
- **æ³•å¸«å…‰ç’°**ï¼šç‚ºäº†æ•ˆèƒ½ï¼Œå…‰ç’°ä¸å†æ˜¯ `effects` é™£åˆ—çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ `draw` è¿´åœˆä¸­ç¹ªè£½ã€‚
- **åœ–ç‰‡é è§£ç¢¼**ï¼šç‚ºäº†é˜²æ­¢é¦–æ¬¡ç¹ªè£½å¡é “ï¼Œåœ–ç‰‡è¼‰å…¥æ™‚æœƒä½¿ç”¨é›¢å± Canvas é å…ˆç¹ªè£½ä¸€æ¬¡ï¼ˆPre-decodingï¼‰ã€‚
- **ç§»å‹•æ’å€¼**ï¼šä½¿ç”¨**ç·šæ€§æ’å€¼**ï¼ˆéæŒ‡æ•¸ï¼‰ï¼Œç¢ºä¿ç§»å‹•é€Ÿåº¦æ†å®šã€‚ä¸è¦æ”¹å›æŒ‡æ•¸æ’å€¼ï¼Œå¦å‰‡æœƒå‡ºç¾ã€Œä¸€æ ¼ä¸€æ ¼è·³å‹•ã€çš„æ„Ÿè¦ºã€‚

### 4. é¿å…å¸¸è¦‹é–‹ç™¼éŒ¯èª¤
- **âŒ é¿å…ã€Œå¹½éˆä»£ç¢¼ã€(Mock Code Overlay)**ï¼š
  - ç¦æ­¢åœ¨æª”æ¡ˆå°¾ç«¯æ·»åŠ ã€Œè‡¨æ™‚æ¸¬è©¦ç”¨ã€çš„å‡½æ•¸ã€‚JavaScript å¾Œå®šç¾©çš„å‡½æ•¸æœƒè¦†è“‹å…ˆå®šç¾©çš„ï¼Œå°è‡´é›£ä»¥æ’æŸ¥çš„ Bugï¼ˆä¾‹å¦‚ç¶“é©—å€¼é¡¯ç¤ºéŒ¯èª¤ï¼‰ã€‚
  - æ¸¬è©¦å®Œæˆå¾Œï¼Œå‹™å¿…å¾¹åº•æ¸…é™¤æ‰€æœ‰ Mock æ•¸æ“šå’Œè‡¨æ™‚å‡½æ•¸ã€‚
  - ä½¿ç”¨ `git diff` ä»”ç´°æª¢æŸ¥æäº¤å…§å®¹ï¼Œç¢ºä¿æ²’æœ‰æ„å¤–ä¿ç•™çš„æ¸¬è©¦ä»£ç¢¼ã€‚
- **âŒ å‡½æ•¸å”¯ä¸€æ€§**ï¼š
  - åœ¨æ–°å¢å‡½æ•¸å‰ï¼Œå…ˆæœå°‹æ˜¯å¦å·²å­˜åœ¨åŒåå‡½æ•¸ã€‚
  - é¿å…ä½¿ç”¨éæ–¼é€šç”¨çš„å‡½æ•¸åç¨±ï¼ˆå¦‚ `updateUI`ï¼‰ï¼Œæ‡‰ä½¿ç”¨å…·é«”åç¨±ï¼ˆå¦‚ `updateLevelUI`ï¼‰ã€‚

---

## ç§»å‹•æµæš¢åº¦ï¼šç·šæ€§æ’å€¼ vs æŒ‡æ•¸æ’å€¼

### å•é¡Œæè¿°
å¯¦ä½œç¢°æ’æ•ˆæœå¾Œï¼Œç©å®¶ç§»å‹•å‡ºç¾æ˜é¡¯å¡é “ï¼Œæœ‰ã€Œä¸€æ ¼ä¸€æ ¼è·³å‹•ã€çš„æ„Ÿè¦ºã€‚æ€ªç‰©ç§»å‹•å»å¾ˆå¹³æ»‘ã€‚

### å•é¡Œåˆ†æ

#### ç‚ºä»€éº¼æ€ªç‰©ç§»å‹•å¹³æ»‘ï¼Ÿ
æ€ªç‰©ä½¿ç”¨**é€£çºŒç§»å‹•**ï¼š
```javascript
// æ¯å¹€éƒ½ç§»å‹•ä¸€å°æ®µè·é›¢
e.x += Math.cos(angle) * ENEMY_SPEED;  // ENEMY_SPEED = 1.2 åƒç´ /å¹€
e.y += Math.sin(angle) * ENEMY_SPEED;
```
- æ¯å¹€ç§»å‹• 1.2 åƒç´ 
- ç´”é€£çºŒç§»å‹•ï¼Œæ²’æœ‰ç¶²æ ¼è·³èº
- ä¸ä½¿ç”¨æ’å€¼ï¼Œæ‰€ä»¥æ²’æœ‰æ’å€¼å•é¡Œ

#### ç‚ºä»€éº¼ç©å®¶ç§»å‹•å¡é “ï¼Ÿ
ç©å®¶ä½¿ç”¨**ç¶²æ ¼ç§»å‹• + æ’å€¼å¹³æ»‘åŒ–**ï¼š
- é‚è¼¯ä½ç½®ï¼ˆ`x, y`ï¼‰æ¯ 120ms è·³å‹•ä¸€æ ¼ï¼ˆ40 åƒç´ ï¼‰
- è¦–è¦ºä½ç½®ï¼ˆ`renderX, renderY`ï¼‰ä½¿ç”¨æ’å€¼å¹³æ»‘éæ¸¡

**å•é¡Œåœ¨æ–¼ä½¿ç”¨äº†æŒ‡æ•¸æ’å€¼**ï¼š
```javascript
// âŒ éŒ¯èª¤ï¼šæŒ‡æ•¸æ’å€¼
s.renderX += (targetX - renderX) * lerpSpeed;  // lerpSpeed = 0.5
```

æŒ‡æ•¸æ’å€¼çš„ç‰¹æ€§ï¼š
- å‰å¹¾å¹€ç§»å‹•å¾ˆå¿«ï¼ˆç¬¬ 1 å¹€ç§»å‹• 50%ï¼Œç¬¬ 2 å¹€ç§»å‹• 25%ï¼Œç¬¬ 3 å¹€ç§»å‹• 12.5%...ï¼‰
- è¶Šæ¥è¿‘ç›®æ¨™è¶Šæ…¢
- å¯èƒ½åœ¨ 40-60ms å°±å®Œæˆ 95% çš„ç§»å‹•
- å‰©ä¸‹ 60-80ms å¹¾ä¹éœæ­¢ï¼ˆåªç§»å‹•æœ€å¾Œçš„ 5%ï¼‰
- é€ æˆã€Œå¿«é€Ÿç§»å‹• â†’ åœé “ â†’ å¿«é€Ÿç§»å‹•ã€çš„å¾ªç’°

### è§£æ±ºæ–¹æ¡ˆï¼šç·šæ€§æ’å€¼

ä½¿ç”¨**ç·šæ€§æ’å€¼**ï¼ˆLinear Interpolationï¼‰ï¼š
```javascript
// âœ… æ­£ç¢ºï¼šç·šæ€§æ’å€¼
const moveProgress = Math.min(timeSinceMove / currentMoveSpeed, 1); // 0.0 åˆ° 1.0
s.renderX = s.startRenderX + (s.targetRenderX - s.startRenderX) * moveProgress;
s.renderY = s.startRenderY + (s.targetRenderY - s.startRenderY) * moveProgress;
```

ç·šæ€§æ’å€¼çš„ç‰¹æ€§ï¼š
- ç§»å‹•é€Ÿåº¦æ†å®š
- 0ms æ™‚åœ¨èµ·é»ï¼ˆ`startRenderX`ï¼‰
- 120ms æ™‚æ­£å¥½åˆ°é”çµ‚é»ï¼ˆ`targetRenderX`ï¼‰
- åœ¨æ•´å€‹ç§»å‹•é–“éš”å…§å‡å‹»ç§»å‹•
- **æ²’æœ‰åœé “æ„Ÿ**

### é—œéµå¯¦ä½œç´°ç¯€

#### 1. è¨˜éŒ„æ’å€¼èµ·é»
åœ¨ `moveSnake` ä¸­ï¼Œç•¶é‚è¼¯ä½ç½®æ›´æ–°æ™‚ï¼š
```javascript
// è¨˜éŒ„æ’å€¼èµ·é»ï¼ˆç•¶å‰çš„è¦–è¦ºä½ç½®ï¼‰
s.startRenderX = s.renderX;
s.startRenderY = s.renderY;
// è¨­ç½®æ–°çš„ç›®æ¨™ä½ç½®ï¼ˆæ–°çš„é‚è¼¯ä½ç½®ï¼‰
s.targetRenderX = s.x;
s.targetRenderY = s.y;
```

#### 2. åœ¨ gameLoop ä¸­æ¯å¹€åŸ·è¡Œæ’å€¼
```javascript
// è¨ˆç®—æ™‚é–“é€²åº¦ï¼ˆ0.0 åˆ° 1.0ï¼‰
const timeSinceMove = timestamp - lastMoveTime;
const moveProgress = Math.min(timeSinceMove / currentMoveSpeed, 1);

// æ ¹æ“šæ™‚é–“é€²åº¦è¨ˆç®—ä½ç½®
snake.forEach(s => {
    s.renderX = s.startRenderX + (s.targetRenderX - s.startRenderX) * moveProgress;
    s.renderY = s.startRenderY + (s.targetRenderY - s.startRenderY) * moveProgress;
});
```

#### 3. åˆå§‹åŒ–æ­£ç¢ºæ€§
åœ¨ `startGame` ä¸­ç¢ºä¿åˆå§‹åŒ–ï¼š
```javascript
snake = [{
    x: startX,
    y: startY,
    renderX: startX,      // è¦–è¦ºä½ç½®
    renderY: startY,
    targetRenderX: startX, // ç›®æ¨™ä½ç½®
    targetRenderY: startY,
    startRenderX: startX,  // æ’å€¼èµ·é»
    startRenderY: startY,
    // ...
}];
```

### å¸¸è¦‹éŒ¯èª¤

âŒ **éŒ¯èª¤ 1ï¼šåœ¨ moveSnake ä¸­é‡ç½® renderX/Y**
```javascript
// é€™æœƒå°è‡´è¦–è¦ºä½ç½®ç›´æ¥è·³åˆ°æ–°ä½ç½®ï¼Œæ²’æœ‰æ’å€¼
s.renderX = prevPositions[i].x;
s.renderY = prevPositions[i].y;
```

âŒ **éŒ¯èª¤ 2ï¼šä½¿ç”¨æŒ‡æ•¸æ’å€¼**
```javascript
// é€™æœƒå°è‡´ç§»å‹•é€Ÿåº¦ä¸å‡å‹»ï¼Œç”¢ç”Ÿåœé “æ„Ÿ
s.renderX += (targetX - renderX) * lerpSpeed;
```

âŒ **éŒ¯èª¤ 3ï¼šä¸è¨˜éŒ„èµ·å§‹ä½ç½®**
```javascript
// é€™æœƒå°è‡´æ’å€¼è¨ˆç®—éŒ¯èª¤ï¼Œç„¡æ³•æº–ç¢ºé æ¸¬åˆ°é”æ™‚é–“
s.targetRenderX = s.x; // åªè¨­ç½®ç›®æ¨™ï¼Œæ²’æœ‰èµ·é»
```

âœ… **æ­£ç¢ºåšæ³•ï¼šç·šæ€§æ’å€¼ + è¨˜éŒ„èµ·é»**
```javascript
// åœ¨ moveSnake ä¸­
s.startRenderX = s.renderX;  // è¨˜éŒ„èµ·é»
s.targetRenderX = s.x;       // è¨­ç½®ç›®æ¨™

// åœ¨ gameLoop ä¸­
const progress = timeSinceMove / moveSpeed;
s.renderX = s.startRenderX + (s.targetRenderX - s.startRenderX) * progress;
```

### èª¿è©¦æŠ€å·§

1. **æª¢æŸ¥æ’å€¼æ˜¯å¦åœ¨åŸ·è¡Œ**ï¼š
   - åœ¨ gameLoop ä¸­è¼¸å‡º `renderX` å’Œ `targetRenderX`
   - ç¢ºèª `renderX` æ˜¯å¦æ¯å¹€éƒ½åœ¨è®ŠåŒ–

2. **æª¢æŸ¥ç§»å‹•é€Ÿåº¦**ï¼š
   - è¼¸å‡º `moveProgress`ï¼Œç¢ºèªæ˜¯å¦å¾ 0 åˆ° 1
   - ç¢ºèª `timeSinceMove` æ˜¯å¦æ­£ç¢ºç´¯ç©

3. **æª¢æŸ¥åˆå§‹åŒ–**ï¼š
   - ç¢ºèª `startRenderX` æ˜¯å¦æ­£ç¢ºè¨˜éŒ„
   - ç¢ºèªæ‰€æœ‰å±¬æ€§éƒ½æœ‰åˆå§‹å€¼

### æ€§èƒ½è€ƒé‡

- **å°‡ç‹€æ…‹æ›´æ–°ç§»åˆ°é‚è¼¯éšæ®µ**ï¼š
  - `hitTimer`ã€`stunTimer` ç­‰è¨ˆæ™‚å™¨åœ¨é‚è¼¯æ›´æ–°éšæ®µæ›´æ–°
  - ç¹ªè£½éšæ®µåªè®€å–ç‹€æ…‹ï¼Œä¸ä¿®æ”¹
  - é¿å…åœ¨ç¹ªè£½å¾ªç’°ä¸­æ›´æ–°ç‹€æ…‹ï¼Œæå‡æ€§èƒ½

- **å›å½ˆæ•ˆæœå„ªåŒ–**ï¼š
  - ä½¿ç”¨è¡°æ¸›ä¿‚æ•¸ï¼ˆ0.95ï¼‰è®“å›å½ˆå¿«é€Ÿæ¶ˆå¤±
  - å›å½ˆåŠ›åº¦é™ä½ï¼ˆ0.3ï¼‰æ¸›å°‘å°ç§»å‹•çš„å½±éŸ¿
  - ç¢ºä¿å›å½ˆä¸å¹²æ“¾æ­£å¸¸ç§»å‹•

## Canvas åº§æ¨™è½‰æ›

### å•é¡Œæè¿°
æ»‘é¼ æ‹–æ›³æ™‚ï¼Œè»Œè·¡ç·šæ®µå‡ºç¾åœ¨æ»‘é¼ ä¸‹æ–¹ç´„ 136px çš„ä½ç½®ã€‚

### åŸå› 
- Canvas æœ‰ `margin-top: 136px`ï¼ˆHUD å€åŸŸé«˜åº¦ï¼‰
- æ»‘é¼ çš„ `clientX` å’Œ `clientY` æ˜¯ç›¸å°æ–¼æ•´å€‹è¦–çª—çš„åº§æ¨™
- ä½† Canvas çš„åº§æ¨™ç³»çµ±æ˜¯å¾ Canvas å·¦ä¸Šè§’é–‹å§‹çš„

### è§£æ±ºæ–¹æ¡ˆ
ä½¿ç”¨ `getBoundingClientRect()` è½‰æ›åº§æ¨™ï¼š

```javascript
function getCanvasCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

canvas.addEventListener("mousemove", (e) => {
    const coords = getCanvasCoordinates(e);
    addTrailPoint(coords.x, coords.y);
});
```

**é—œéµé»**ï¼š
- `rect.left` å’Œ `rect.top` æ˜¯ Canvas ç›¸å°æ–¼è¦–çª—çš„ä½ç½®
- æ¸›å»é€™äº›å€¼å¾—åˆ° Canvas å…§éƒ¨çš„ç›¸å°åº§æ¨™
- è§¸æ§äº‹ä»¶ä¹Ÿéœ€è¦ç›¸åŒçš„è™•ç†

## å‡ç´šç³»çµ±é…ç½®æŠ€å·§

### è² æ•¸ increment çš„é¡¯ç¤ºè™•ç†
ç§»å‹•é€Ÿåº¦å‡ç´šä½¿ç”¨è² æ•¸ incrementï¼ˆæ¸›å°‘ç§»å‹•é–“éš”ï¼‰ï¼š

```javascript
// upgrade-config.js
moveSpeed: {
    name: "ç§»å‹•é€Ÿåº¦",
    description: "éšŠé•·ç§»å‹•é€Ÿåº¦æå‡ï¼ˆç§»å‹•é–“éš”æ¸›å°‘ {value} æ¯«ç§’ï¼‰",
    baseValue: 200,
    increment: -15,  // è² æ•¸ï¼
}
```

é¡¯ç¤ºæ™‚éœ€è¦è™•ç†ï¼š
```javascript
// å°æ–¼è² æ•¸ incrementï¼Œé¡¯ç¤ºçµ•å°å€¼
const displayValue = Math.abs(option.upgrade.increment || 1);
let descText = option.upgrade.description.replace("{value}", displayValue);
```

## é…ç½®æ–‡ä»¶è¨­è¨ˆæ¨¡å¼

æ‰€æœ‰é…ç½®æ–‡ä»¶ä½¿ç”¨ç›¸åŒçš„æ¨¡å¼ï¼š

```javascript
// xxx-config.js
window.XXX_CONFIG = {
    // é…ç½®å…§å®¹
};
```

**å„ªé»**ï¼š
- ä¼åŠƒäººå“¡å¯ç›´æ¥ç·¨è¼¯ï¼Œç„¡éœ€æ‡‚ç¨‹å¼
- ä½¿ç”¨ `window.XXX_CONFIG` ä½œç‚ºå…¨åŸŸè®Šæ•¸
- åœ¨ `index.html` ä¸­è¼‰å…¥ï¼š`<script src="xxx-config.js"></script>`
- åœ¨ `script.js` ä¸­ä½¿ç”¨ï¼š`window.XXX_CONFIG`

**ç¾æœ‰é…ç½®æ–‡ä»¶**ï¼š
- `guide-config.js`ï¼šéŠæˆ²èªªæ˜
- `upgrade-config.js`ï¼šå‡ç´šç³»çµ±
- `enemy-spawn-config.js`ï¼šæ€ªç‰©ç”Ÿæˆ
- `hero-quotes-config.js`ï¼šå‹‡è€…ä»Šæ—¥åè¨€

## UI å¸ƒå±€è¨­è¨ˆ

### é ‚éƒ¨ HUD å€åŸŸ
ä½¿ç”¨ç¨ç«‹å€åŸŸï¼Œä¸é®æ“‹éŠæˆ²ï¼š

```css
.hud-top-bar {
    position: absolute;
    top: 0;
    width: 100%;
    height: 136px;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(4px);
}

canvas#gameCanvas {
    margin-top: 136px;
    height: calc(100% - 136px);
}
```

**å„ªé»**ï¼š
- HUD èˆ‡éŠæˆ²å€åŸŸåˆ†é›¢
- éŠæˆ²å€åŸŸä¸è¢«é®æ“‹
- è¦–è¦ºæ›´æ¸…æ™°

### éŸ¿æ‡‰å¼è¨­è¨ˆ
ä½¿ç”¨ Flexbox è‡ªå‹•æ’åˆ—ï¼š
```css
.hud-top-bar {
    display: flex;
    gap: 12px;
}

.minimap-container {
    width: 120px;
    flex-shrink: 0;  /* ä¸ç¸®å° */
}

.top-stats {
    flex: 1;  /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
    min-width: 0;  /* å…è¨±ç¸®å° */
}
```

## æ•ˆèƒ½å„ªåŒ–åŸå‰‡

1. **é‚è¼¯èˆ‡ç¹ªè£½åˆ†é›¢**ï¼š
   - é‚è¼¯æ›´æ–°åœ¨å›ºå®šé–“éš”ï¼ˆ120msï¼‰
   - ç¹ªè£½åœ¨æ¯å¹€ï¼ˆ~16ms @ 60fpsï¼‰
   - æ’å€¼åœ¨æ¯å¹€åŸ·è¡Œï¼Œè®“è¦–è¦ºå¹³æ»‘

2. **ç‹€æ…‹æ›´æ–°åœ¨é‚è¼¯éšæ®µ**ï¼š
   - è¨ˆæ™‚å™¨ï¼ˆ`hitTimer`, `stunTimer`ï¼‰åœ¨é‚è¼¯æ›´æ–°
   - ç¹ªè£½éšæ®µåªè®€å–ï¼Œä¸ä¿®æ”¹
   - é¿å…åœ¨ç¹ªè£½å¾ªç’°ä¸­æ›´æ–°ç‹€æ…‹

3. **è¦–è¦ºæ•ˆæœä¸å½±éŸ¿é‚è¼¯**ï¼š
   - å›å½ˆæ•ˆæœåªå½±éŸ¿ `renderX/Y`
   - ä¸å½±éŸ¿é‚è¼¯ä½ç½®ï¼ˆ`x, y`ï¼‰
   - ç¢ºä¿éŠæˆ²é‚è¼¯ä¸€è‡´æ€§

## èƒ½åŠ›é¡å‹é™åˆ¶ç³»çµ±

### è¨­è¨ˆç›®çš„
æ¯è¼ªéŠæˆ²æœ€å¤šå¯è§£é– 10 ç¨®ä¸åŒçš„èƒ½åŠ›é¡å‹ï¼Œé¼“å‹µç©å®¶å°ˆç²¾ç‰¹å®šèƒ½åŠ›ï¼Œå¢åŠ ç­–ç•¥æ€§å’Œé‡ç©åƒ¹å€¼ã€‚

### å¯¦ç¾æ–¹å¼
- ä½¿ç”¨ `Set` æ•¸æ“šçµæ§‹è¿½è¹¤å·²è§£é–çš„èƒ½åŠ›é¡å‹ï¼ˆæ ¼å¼ï¼š`role.key`ï¼‰
- å‡ç´šæ™‚æª¢æŸ¥æ˜¯å¦ç‚ºæ–°èƒ½åŠ›ï¼ˆ`upgradeLevels[role][key] === 1`ï¼‰
- å¦‚æœæ˜¯æ–°èƒ½åŠ›ï¼ŒåŠ å…¥ `unlockedAbilityTypes` Set
- å¦‚æœæ¸›åˆ° 0ï¼Œå¾ Set ä¸­ç§»é™¤
- ç”Ÿæˆå‡ç´šé¸é …æ™‚ï¼Œæª¢æŸ¥ `unlockedAbilityTypes.size < abilityTypeLimit`

### é—œéµä»£ç¢¼
```javascript
// è¿½è¹¤å·²è§£é–çš„èƒ½åŠ›é¡å‹
let unlockedAbilityTypes = new Set(); // æ ¼å¼ï¼šrole.key

// å‡ç´šæ™‚æª¢æŸ¥æ˜¯å¦ç‚ºæ–°èƒ½åŠ›
if (upgradeLevels[role][key] === 1 && !isUnlocked) {
    unlockedAbilityTypes.add(abilityTypeKey);
    updateAbilityTypeUI();
}

// ç”Ÿæˆé¸é …æ™‚æª¢æŸ¥é™åˆ¶
const isAtLimit = unlockedAbilityTypes.size >= abilityTypeLimit;
if (!isUnlocked && isAtLimit) {
    // ä¸èƒ½è§£é–æ–°èƒ½åŠ›
}
```

## çˆ†ç‚¸æ•ˆæœç³»çµ±

### é¨å£«æ­»äº¡çˆ†ç‚¸
- **è§¸ç™¼æ™‚æ©Ÿ**ï¼šé¨å£« hitPoints æ­¸é›¶æ™‚
- **å‚·å®³è¨ˆç®—**ï¼šå°ç¯„åœå…§æ‰€æœ‰æ•µäººé€ æˆ `getKnightExplosionDamage()` å‚·å®³
- **ç¯„åœè¨ˆç®—**ï¼šä½¿ç”¨ `getKnightExplosionRange()` è¨ˆç®—çˆ†ç‚¸åŠå¾‘
- **è¦–è¦ºç‰¹æ•ˆ**ï¼šé‡‘è‰²çˆ†ç‚¸ç‰¹æ•ˆï¼ˆ`#f59e0b`ï¼‰ï¼Œå¾ä¸­å¿ƒå‘å¤–æ“´æ•£ï¼Œé€æ¼¸æ·¡å‡º

### å¼“ç®­çˆ†ç‚¸
- **è§¸ç™¼æ™‚æ©Ÿ**ï¼šç®­çŸ¢æ“Šä¸­æ•µäººæ™‚
- **å‚·å®³è¨ˆç®—**ï¼šå°ç¯„åœå…§å…¶ä»–æ•µäººé€ æˆ `getArcherExplosionDamage()` å‚·å®³ï¼ˆä¸åŒ…æ‹¬è¢«ç›´æ¥æ“Šä¸­çš„æ•µäººï¼‰
- **ç¯„åœè¨ˆç®—**ï¼šä½¿ç”¨ `getArcherExplosionRange()` è¨ˆç®—çˆ†ç‚¸åŠå¾‘
- **è¦–è¦ºç‰¹æ•ˆ**ï¼šç¶ è‰²çˆ†ç‚¸ç‰¹æ•ˆï¼ˆ`#22c55e`ï¼‰ï¼Œç’°ç‹€æ“´æ•£

### å¯¦ç¾ç´°ç¯€
```javascript
// æª¢æŸ¥ç¯„åœå…§æ•µäºº
enemies.forEach(enemy => {
    const dx = enemy.x - explosionX;
    const dy = enemy.y - explosionY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist <= explosionRange) {
        damageEnemy(enemy, explosionDamage);
    }
});

// æ·»åŠ çˆ†ç‚¸ç‰¹æ•ˆ
effects.push({
    type: "knight-explosion" | "arrow-explosion",
    x, y,
    radius: 0,
    maxRadius: explosionRange,
    life: 20 | 15,
    alpha: 0.8 | 0.7,
    color: "#f59e0b" | "#22c55e"
});
```

## æ³•å¸«ç¸®æ”¾æ•ˆæœ

### è¨­è¨ˆç›®çš„
è®“æ³•å¸«æœ‰å‘¼å¸å¼çš„å‹•æ…‹æ„Ÿï¼Œè¦–è¦ºä¸Šæ›´åŠ ç”Ÿå‹•æœ‰è¶£ã€‚

### å¯¦ç¾æ–¹å¼
- ä½¿ç”¨ `performance.now()` è¿½è¹¤æ™‚é–“
- æ¯ 2000ms ä¸€å€‹å®Œæ•´çš„ç¸®æ”¾å¾ªç’°
- ä½¿ç”¨ `Math.sin()` å‰µå»ºå¹³æ»‘çš„ç¸®æ”¾æ›²ç·š
- æ‡‰ç”¨ Canvas è®Šæ›å¯¦ç¾å¾ä¸­å¿ƒé»ç¸®æ”¾

### é—œéµä»£ç¢¼
```javascript
// è¨ˆç®—ç¸®æ”¾é€²åº¦ï¼ˆ0.0 åˆ° 1.0ï¼‰
const currentTime = performance.now();
const elapsed = currentTime - mageScaleStartTime;
const cycleDuration = 2000; // 2ç§’
const progress = (elapsed % cycleDuration) / cycleDuration;

// ä½¿ç”¨ sin å‡½æ•¸å‰µå»ºå¹³æ»‘æ›²ç·š
const scaleFactor = Math.sin(progress * Math.PI); // 0 â†’ 1 â†’ 0
const maxScale = 1.0 + (scaleBonus / 100); // ä¾‹å¦‚ scaleBonus=30 æ™‚ï¼ŒmaxScale=1.3
mageScale = 1.0 + (maxScale - 1.0) * scaleFactor;

// æ‡‰ç”¨ç¸®æ”¾è®Šæ›ï¼ˆå¾ä¸­å¿ƒé»ï¼‰
const centerX = pos.x + GRID_SIZE / 2;
const centerY = pos.y + GRID_SIZE / 2;
ctx.translate(centerX, centerY);
ctx.scale(mageScale, mageScale);
ctx.translate(-centerX, -centerY);
```

### æ³¨æ„äº‹é …
- å…‰ç’°è¦–è¦ºå¤§å°ä¹Ÿè·Ÿéš¨ç¸®æ”¾ï¼Œä½†å¯¦éš›å‚·å®³ç¯„åœä¸è®Š
- ç¸®æ”¾æ•ˆæœåªå½±éŸ¿è¦–è¦ºï¼Œä¸å½±éŸ¿ç¢°æ’æª¢æ¸¬å’Œå‚·å®³åˆ¤å®š

## æ¸¬è©¦åŠŸèƒ½å¯¦ç¾

### è¨­è¨ˆç›®çš„
æ–¹ä¾¿é–‹ç™¼å’Œæ¸¬è©¦å„ç¨®èƒ½åŠ›çµ„åˆï¼Œé©—è­‰éŠæˆ²å¹³è¡¡æ€§ã€‚

### å¯¦ç¾æ–¹å¼
- å¯†ç¢¼ä¿è­·ï¼šä½¿ç”¨ç°¡å–®çš„å­—ç¬¦ä¸²æ¯”è¼ƒï¼ˆ`password === DEBUG_PASSWORD`ï¼‰
- å‹•æ…‹ç”Ÿæˆä¿®æ”¹é¢æ¿ï¼šæ ¹æ“š `upgrade-config.js` è‡ªå‹•ç”Ÿæˆæ‰€æœ‰èƒ½åŠ›é¸é …
- å¯¦æ™‚æ›´æ–°ï¼šä¿®æ”¹ç­‰ç´šæ™‚ç«‹å³æ›´æ–° `upgradeLevels` å’Œ `unlockedAbilityTypes`
- é™åˆ¶æª¢æŸ¥ï¼šèƒ½åŠ›é¡å‹é”ä¸Šé™æ™‚ï¼Œæœªè§£é–é¸é …è®ŠåŠé€æ˜ä¸”ç„¡æ³•é»æ“Š

### é—œéµä»£ç¢¼
```javascript
// æ¸²æŸ“ä¿®æ”¹é¢æ¿
function renderDebugPanel() {
    // éæ­·æ‰€æœ‰å‡ç´šé¸é …
    Object.keys(config).forEach(role => {
        Object.keys(config[role]).forEach(key => {
            const isUnlocked = unlockedAbilityTypes.has(`${role}.${key}`);
            const isDisabled = !isUnlocked && isAtLimit;
            // ç”Ÿæˆ HTML...
        });
    });
    
    // ç¶å®šåŠ æ¸›æŒ‰éˆ•äº‹ä»¶
    // å¢åŠ æ™‚æª¢æŸ¥é™åˆ¶ï¼Œæ¸›å°‘æ™‚æ›´æ–°è¿½è¹¤
}
```

### å®‰å…¨è€ƒé‡
- å¯†ç¢¼åƒ…ç”¨æ–¼é˜²æ­¢èª¤è§¸ï¼Œä¸æ˜¯çœŸæ­£çš„å®‰å…¨æªæ–½
- æ¸¬è©¦åŠŸèƒ½åƒ…åœ¨é–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼Œç”Ÿç”¢ç’°å¢ƒå¯è€ƒæ…®ç§»é™¤
